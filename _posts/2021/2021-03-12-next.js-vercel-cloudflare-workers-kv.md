---
title: "Next.js + Vercel + Cloudflare Workers KV + Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã§å¯„ä»˜ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã£ãŸ"
author: azu
layout: post
date : 2021-03-12T18:33
category: JavaScript
tags:
    - JavaScript
    - å¯„ä»˜
    - donation
    - Philanthropy

---

[philan.net](https://philan.net/)ã¨ã„ã†å¯„ä»˜ã®äºˆç®—ã‚’æ±ºã‚ã¦å¯„ä»˜ã—ãŸè¨˜éŒ²ã‚’ã¤ã‘ã‚‹ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã£ãŸã®ã§ã€ã“ã®è¨˜äº‹ã§ã¯æŠ€è¡“çš„ãªéƒ¨åˆ†ã®è§£èª¬ã‚’ã—ã¾ã™ã€‚
[philan.net](https://philan.net/)è‡ªä½“ã«ã¤ã„ã¦ã¯ã€æ¬¡ã®è¨˜äº‹ã§è§£èª¬ã—ã¦ã„ã¾ã™ã€‚

- [å¯„ä»˜ã‚’ã™ã‚‹ãŸã‚ã«ã€å¯„ä»˜ã®äºˆç®—ã¨å¯„ä»˜ã®è¨˜éŒ²ã‚’SpreadSheetãƒ™ãƒ¼ã‚¹ã§ã¤ã‘ã‚‹ philan.net ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã£ãŸ | Web Scratch](https://efcl.info/2021/03/10/philan.net/)

ã“ã®è¨˜äº‹ã§ã¯ã€[Next.js](https://nextjs.org/) + [Vercel](https://vercel.com) + [Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/) + [Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆ](https://www.google.com/intl/ja_jp/sheets/about/)ã‚’ä½¿ã£ã¦å‹•ã„ã¦ã„ã‚‹[philan.net](https://philan.net/)ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

ã‚ã¨æ¤œè¨¼ä¸­ã«[Cloudflare Workers](https://workers.cloudflare.com/)ã‚’è‰²ã€…ã„ã˜ã£ãŸã®ã§ãã‚Œã«ã¤ã„ã¦ã‚‚æ›¸ã„ã¦ã„ãã¾ã™ã€‚

## Idea

[philan.netã‚’ä½œã£ãŸç†ç”±](https://efcl.info/2021/03/10/philan.net/)ã§ã‚‚æ›¸ã„ã¦ã„ã¾ã—ãŸãŒã€äºˆç®—ã‚’æ±ºã‚ã¦ãŠãã“ã¨ã§å¯„ä»˜ã™ã‚‹ã¨ãã®æ°—æŒã¡ã‚’æ¥½ã«ã™ã‚‹ã‚‚ã®ã‚’ä½œã‚ã†ã¨ã—ãŸã®ãŒã‚¹ã‚¿ãƒ¼ãƒˆã§ã™ã€‚
ã“ã®å¯„ä»˜ã®å…¬é–‹å®¶è¨ˆç°¿çš„ãªã‚µãƒ¼ãƒ“ã‚¹ã¯æ¬¡ã®ã‚ˆã†ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚

- å®¶è¨ˆç°¿ã®ã‚ˆã†ã«è‡ªåˆ†ã®å¯„ä»˜ã‚’ç®¡ç†ã™ã‚‹
- budget(äºˆç®—)ã®è¨­å®š
- å¯„ä»˜ã®å±¥æ­´ã®ç™»éŒ²
- å¹´æœ«èª¿æ•´ç”¨ã®ä¾¿åˆ©ãªä½•ã‹
- publicã«å…¬é–‹ã™ã‚‹ãŸã‚ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªçš„ãªãƒšãƒ¼ã‚¸
- ãªãœå¯„ä»˜ã—ãŸã®ã‹ã‚’ãƒ¡ãƒ¢ã§ãã‚‹ã‚‚ã®

ã“ã‚Œã‚’æ©Ÿèƒ½çš„ã«è¦‹ã¦ã„ãã¨ã€ã¤ãã®ã‚ˆã†ãªè¦ç´ ãŒå¿…è¦ã§ã—ãŸã€‚

- äºˆç®—ã‚’è¨˜éŒ²ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- å¯„ä»˜å…ˆã€é‡‘é¡ã€ãƒ¡ãƒ¢ãªã©ã‚’ç™»éŒ²ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³çš„ã«ä¸€è¦§ã‚’è¡¨ç¤ºã§ãã‚‹ãƒšãƒ¼ã‚¸

ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹UIçš„ãªã‚µãƒ¼ãƒ“ã‚¹ã«ãªã‚Šãã†ã§ã™ã€‚
ã“ã†ã„ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çš„ãªã‚µã‚¤ãƒˆã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã“ã«ç½®ãã‹ãŒã‚³ã‚¹ãƒˆã«ç›´çµã™ã‚‹ã®ã§ã€ã¾ãšã¯ã‚³ã‚¹ãƒˆã®é¢ã‹ã‚‰è€ƒãˆã¦ã„ãã¾ã—ãŸã€‚

ã‚³ã‚¹ãƒˆã‚’æœ€å°åŒ–ã™ã‚‹ã“ã¨ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã®ç¶™ç¶šæ€§ã«ç›´çµã™ã‚‹ã®ã§ã€ã‚³ã‚¹ãƒˆã‚¼ãƒ­ã‚’ç›®æŒ‡ã—ã¦è¨­è¨ˆã—ã¦ã„ã¾ã™ã€‚

å®Ÿéš›ã«ç¾æ™‚ç‚¹ã®[philan.net](https://philan.net/)ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³è²»ç”¨ä»¥å¤–ã¯ã€ç‰¹ã«è²»ç”¨ã¯ã‹ã‹ã£ã¦ã„ã¾ã›ã‚“ã€‚

## ã‚³ã‚¹ãƒˆ

ã‚³ã‚¹ãƒˆã¯æ¬¡ã®ã‚ˆã†ãªãƒ¡ãƒ¢æ›¸ãã‚’ã—ãªãŒã‚‰è€ƒãˆã¦ã„ã¾ã—ãŸã€‚

---

ãƒ¡ãƒ¢æ›¸ã

- APIã¯Serverlessãƒ™ãƒ¼ã‚¹
  - Cloud Run
  - Cloudflare Workers
  - Lambda
- DatabaseãŒã‚„ã£ã±ã‚Šèª²é¡Œ?
    - [Firebase Realtime Database](https://firebase.google.com/docs/database?hl=ja)
- ãƒ‡ãƒ¼ã‚¿ç‰¹æ€§
    - ãã“ã¾ã§æ›¸ãè¾¼ã¿ã¯ç™ºç”Ÿã—ãªã„
    - åŒæ™‚ç·¨é›†ã¯å®Ÿéš›ã«ã¯èµ·ããªã„(å„è‡ªã®ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã™ã‚‹ã ã‘ãªã®ã§)
    - èª­ã¿è¾¼ã¿ãŒå¤šã„
- Google Spreadsheetã‚’ç”¨æ„ã—ã¦ã‚‚ã‚‰ã£ã¦ã€ãã‚Œã«èª­ã¿æ›¸ãã™ã‚‹ä»•çµ„ã¿ã¨ã‹?
    - GASã‚’ä»•è¾¼ã‚“ã ã‚·ãƒ¼ãƒˆã‚’ç”¨æ„ã—ã¦ãã‚Œã‚’ä½¿ã†
    - [Airtable](https://airtable.com/)çš„ãªæ„Ÿã˜?
- Google spreadsheet + cloudflare worker kv + lambda??

---

å®Ÿãƒ‡ãƒ¼ã‚¿ã¯[Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆ](https://www.google.com/intl/ja_jp/sheets/about/)ã«æ›¸ãè¾¼ã‚“ã§ã€
ãã‚Œã‚’æ‰±ã†ä»•çµ„ã¿ãŒã‚ã‚Œã°ååˆ†ãã†ã ãªã¨æ€ã£ã¦ã€ [Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆ](https://www.google.com/intl/ja_jp/sheets/about/) + [Cloudflare Workers](https://workers.cloudflare.com/) + [Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/)ã§æ¤œè¨¼ã—ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

## [Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆ](https://www.google.com/intl/ja_jp/sheets/about/) + [Cloudflare Workers](https://workers.cloudflare.com/) + [Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/)

[Cloudflare Workers](https://workers.cloudflare.com/)ã¯CDN Edgeã§å‹•ãLambdaã¿ãŸã„ãªã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
CPU runtimeã®åŒæœŸå‡¦ç†ã¯Freeã ã¨10ms(æœ‰æ–™ã¯50msã€ã“ã®æ™‚é–“ã¯åŒæœŸçš„ãªå‡¦ç†ã ã‘ãªã®ã§Fetchã‚„éåŒæœŸå‡¦ç†ã¯è¨ˆç®—å¤–ã¨ãªã‚‹)ã€Worker MemoryãŒ128MBã¨ã„ã£ãŸ[Limits](https://developers.cloudflare.com/workers/platform/limits)ãŒã‚ã‚Šã¾ã™ãŒã€éåŒæœŸå‡¦ç†ãŒãƒ¡ã‚¤ãƒ³ãªã‚‰ååˆ†ã«ä½¿ãˆã¦ã‚‚ã®ã™ã”ãæ—©ã„ã§ã™ã€‚
[English Notes](https://english-notes.jser.workers.dev/)ã¨ã„ã†ã€GitHub Issuesã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã—ãŸãƒ–ãƒ­ã‚°ã‚’ä½œã£ãŸã‚Šã—ã¾ã—ãŸãŒã€30~50msã§è¿”ã£ã¦ãã‚‹ã‚µã‚¤ãƒˆãŒä½œã‚Œã¾ã™ã€‚(åˆå›ã¯CDNä¸Šã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„ãŸã‚ã€GraphQLã§GitHubã®APIã‚’å©ãã¾ã™ãŒã€ãã‚Œã§ã‚‚1ç§’ä»¥å†…ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã›ã¾ã™)

- [Cloudflare Workers + GitHub Issues + GitHub Actionsã§ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹ - English Notes](https://english-notes.jser.workers.dev/entry/3)

[Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/)ã¯ã€Cloudflare Workersã§ä½¿ãˆã‚‹çµæœæ•´åˆæ€§ã®KVSã§ã™ã€‚

- [How KV works Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/learning/how-kv-works)
- [KV Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/runtime-apis/kv)

Cloudflare Workersã‹ã‚‰ã—ã‹ä½¿ãˆãªã„ã‚ˆã†ã«è¦‹ãˆã¾ã™ãŒã€å®Ÿéš›ã«ã¯APIã‹ã‚‰ã‚‚è§¦ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€Cloudflareã®CDNä¸Šã«ã‚ã‚‹KVSã¿ãŸã„ãªã‚‚ã®ã¨ã—ã¦ä½¿ãˆã¾ã™ã€‚

- https://api.cloudflare.com/#workers-kv-namespace-properties

Cloudflare Workersã¯Lambdaã¿ãŸã„ã«ä»»æ„ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã›ã¾ã™ãŒã€ã‚µã‚¤ãƒˆã‚’ä½œã‚‹ã«ã¯ç”»åƒãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã‚‚ãã®ã¾ã¾æ‰±ãˆã‚‹ã»ã†ãŒæ¥½ã§ã™ãŒã€[Workers Sites](https://developers.cloudflare.com/workers/platform/sites)ã‚’ä½¿ã†ã¨ãã‚ŒãŒã§ãã¾ã™ã€‚
[Workers Sites](https://developers.cloudflare.com/workers/platform/sites)ã®å®Ÿæ…‹ã¯ã€[Cloudflare Workers](https://workers.cloudflare.com/) + [Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/)ã§ã™ã€‚

[@cloudflare/kv-asset-handler](https://github.com/cloudflare/kv-asset-handler)ã¨ã„ã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã†ã¨ã€Cloudflare Workers KVã«å¯¾ã—ã¦é™çš„ãªã‚¢ã‚»ãƒƒãƒˆã‚’ä¿å­˜ã—ã¦ã€Cloudflare Workersã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã¦ãã‚Œã‚‹ã¨ã„ã†å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã‚’çµ„ã¿åˆã‚ã›ã‚Œã°æ¬¡ã®ã‚ˆã†ãªæ„Ÿã˜ã§ä½œã‚Œãã†ãªæ°—ãŒã—ã¾ã—ãŸã€‚

- é™çš„ãªã‚¢ã‚»ãƒƒãƒˆ: Workers Sites(Workers + Workers KV)
- ãƒ­ã‚¸ãƒƒã‚¯: Workers
- KVS: Workers KV
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: Google spreadsheet

ã“ã®æ§‹æˆã§ä½œã‚ã†ã¨ã—ãŸæ®‹éª¸ãŒ[philan.net/worker](https://github.com/azu/philan.net/tree/1ab224dc6961201b4d16c7c475fc6493a8f8a604/worker)ã«ã‚ã‚Šã¾ã™ãŒã€å®Ÿéš›ã«ã¯ã„ãã¤ã‹ã®å•é¡ŒãŒã‚ã£ã¦ã“ã®æ§‹æˆã¯é›£ã—ã‹ã£ãŸã®ã§ã‚„ã‚ã¾ã—ãŸã€‚

### å•é¡Œç‚¹

[Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆ](https://www.google.com/intl/ja_jp/sheets/about/) + [Cloudflare Workers](https://workers.cloudflare.com/) + [Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/)ã ã¨ã€ã„ãã¤ã‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

#### é–‹ç™ºç’°å¢ƒ

Cloudflare Workersã¯[wrangler](https://github.com/cloudflare/wrangler)ã‚’ä½¿ã†ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ç™ºãŒã§ãã¾ã™ã€‚
`wrangler dev` ã‚’ä½¿ã†ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ã—ã¦é–‹ç™ºã§ãã¾ã™ãŒã€ã“ã®Workersã¯å®Ÿéš›ã«ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã„ã¦ã„ã‚‹ã®ã§ã¯ãªãã€å¤‰æ›´ã™ã‚‹ãŸã³ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã™ã€‚

- [`wrangler dev` runs published worker, not local Â· Issue #1784 Â· cloudflare/wrangler](https://github.com/cloudflare/wrangler/issues/1784)

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã‚‹ã“ã¨è‡ªä½“ã¯ãã‚Œè‡ªä½“ãŒæ—©ã„(å¤§ä½“æ•°ç§’ã§åæ˜ ã•ã‚Œã‚‹)ã®ã§å•é¡Œãªã„ã®ã§ã™ãŒã€ãƒªãƒ¢ãƒ¼ãƒˆã§å‹•ã„ã¦ã„ã‚‹ãŸã‚Workersã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ‡ãƒãƒƒã‚¯ã—ã¦ã„ã‚‹ã¨ãã«`localhost`ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã°ã›ãªã„ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã¯Cloudflarer Workersã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ `localhoost` ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã‚‚ã€å®Ÿéš›ã«ã¯Cloudflareä¸Šã§å‹•ã„ã¦ã„ã‚‹Workersãªã®ã§localhostã¯Cloudflareã«ãªã‚Šã¾ã™ã€‚Cloudflareä¸Šã§localhostã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨503ãŒè¿”ã£ã¦ãã¾ã™ã€‚

ãã®ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ‡ãƒãƒƒã‚°ä¸­ã«localhostã‚’å‚ç…§ã—ãŸã„å ´åˆã¯ã€[localtunnel](https://github.com/localtunnel/localtunnel)ãªã©ã®localhostã‚’å…¬é–‹ã™ã‚‹ä»•çµ„ã¿ãŒå¿…è¦ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

#### ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ãŒå¼±ã„

[Cloudflare Workers](https://workers.cloudflare.com/)ã¯ã€Service Workersãƒ©ã‚¤ã‚¯ãªAPIã§ã™ãŒã€ã¾ã ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ãŒæ®†ã©ã‚ã‚Šã¾ã›ã‚“ã€‚

Expressã£ã½ã„ã‚‚ã®ãªã‚‰[SunderJS/sunder](https://github.com/SunderJS/sunder)ãŒã¾ãšã¾ãšã§ã™ãŒã€Express middlewareãªã©Node.jsã®APIã«ä¾å­˜ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯å‹•ã‹ãªã„ã®ã§ã€ãã“ã‹ã‚‰ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
(Node.jsã®APIã‚’ä½¿ã£ã¦ãªã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã‚‰webpackã§bundleã•ã‚Œã‚‹ãŸã‚å‹•ã)

- [cfworker/cfworker: A collection of packages optimized for Cloudflare Workers and service workers.](https://github.com/cfworker/cfworker)

å…·ä½“çš„ã«ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ä»•çµ„ã¿(Cookieå‡¦ç†)ã€OAuthå‘¨ã‚Šã®å‡¦ç†ãªã©ã‚’å…¨éƒ¨è‡ªåˆ†ã§æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- https://github.com/azu/philan.net/blob/1ab224dc6961201b4d16c7c475fc6493a8f8a604/worker/src/workers-api.ts#L13-L19
  - ã‚„ã‚ã†ã¨ã—ãŸã‘ã©è«¦ã‚ãŸæ®‹éª¸

#### å‹ãŒå¾®å¦™

å…¬å¼ã«[cloudflare/workers-types: TypeScript type definitions for authoring Cloudflare Workers.](https://github.com/cloudflare/workers-types)ãŒã‚ã‚‹ã®ã§å‹ã¯ã‚ã‚Šã¾ã™ã€‚

ãŸã ã—ã€globalã«å‹ã‚’è¿½åŠ ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸(Cloudflare Workersã®runtimeã®å‹ãªã®ã§ãã†ãªã‚‹)ãªã®ã§ã€ã“ã®å‹å®šç¾©ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ä½¿ã†ã¨ã‹ãŒé›£ã—ã„ã§ã™ã€‚
[cloudflare/workers-types](https://github.com/cloudflare/workers-types)ã‹ã‚‰å‹ãŒexportã•ã‚Œã¦ãªã„ã®ã§ã€Cloudflare Workerså‘ã‘ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½œã‚Šã«ãã„æ„Ÿã˜ã§ã—ãŸã€‚

---

ã“ã®ã‚ˆã†ãªå•é¡ŒãŒã‚ã‚Šã€è‡ªåˆ†ã§ã™ã¹ã¦æ›¸ã‘ã°ã§ããªããªã„ã‘ã©æ™‚é–“çš„ã«é›£ã—ã„ã®ã§è«¦ã‚ã¾ã—ãŸã€‚
ãƒ­ã‚¸ãƒƒã‚¯ã¯Node.jsã‚’å‹•ã‹ã›ã‚‹ã‚‚ã®ã§æ›¸ã„ãŸã»ã†ãŒã‚³ã‚¹ãƒ‘ãŒè‰¯ã•ãã†ãªã®ã§ã€åˆ¥ã®æ§‹æˆã‚’è€ƒãˆã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

## [Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆ](https://www.google.com/intl/ja_jp/sheets/about/) + [Cloudflare Workers](https://workers.cloudflare.com/) + [Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/) + [Next.js](https://nextjs.org/)

```diff
é™çš„ãªã‚¢ã‚»ãƒƒãƒˆ: Workers Sites(Workers + Workers KV)
- ãƒ­ã‚¸ãƒƒã‚¯: Workers
+ ãƒ­ã‚¸ãƒƒã‚¯: Workersã€Next.js API
KVS: Workers KV
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: Google spreadsheet
```

å…ˆã»ã©ã®æ§‹æˆã«Node.jsã§APIã‚µãƒ¼ãƒ(serverless)ã‚’ä½¿ãˆã‚‹[Next.js](https://nextjs.org/)ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ãŸã€‚
Google APIã‚’å©ããŸã‚ã®OAuthãªã©ã®Node.jsã‚’ä½¿ã£ã¦ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸€éƒ¨ã‚’[Cloudflare Workers](https://workers.cloudflare.com/)ã‹ã‚‰[Next.js](https://nextjs.org/)ã®APIã«ç§»ã™ã¨ã„ã†ä½œæˆ¦ã§ã™ã€‚

![Cloudflare Worker â†’ Proxy â†’ Next.js's API](https://efcl.info/wp-content/uploads/2021/03/Cloudflare-Workers-Next.js.png)

<!-- https://excalidraw.com/#json=5864778035625984,LJfrAGeQP5Zke122qtZjeg -->

> Cloudflare Worker â†’ Proxy â†’ Next.js's API

ã—ã‹ã—ã€ã“ã®æ§‹æˆã ã¨Cloudflare Workersã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—ã¦ã„ã‚‹Next.js's APIã‚’å©ãã®ãŒé›£ã—ã„ã§ã™ã€‚
å…ˆã»ã©æ›¸ã„ãŸã‚ˆã†ã«ã€Cloudflare Workersã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚ã£ã¦ã‚‚ãƒªãƒ¢ãƒ¼ãƒˆã§å‹•ã„ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
[localtunnel](https://github.com/localtunnel/localtunnel)ã‚’é€šã›ã°ãªã‚“ã¨ã‹ãªã‚Šã¾ã™ãŒã€é–‹ç™ºä½“é¨“ã¯è‰¯ãã‚ã‚Šã¾ã›ã‚“ã€‚(ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒå…¥ã‚‹ã®ã§é…ã„)

ğŸ“ Lambdaã¨ã‹ã˜ã‚ƒãªãã¦Next.jsã®APIã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã¯ã€Next.jsã®`api/`è‡ªä½“ãŒæ™®é€šã«ã‚ˆãã§ãã¦ã„ã¦ä¾¿åˆ©ã ã£ãŸãŸã‚ã€‚
ãƒ­ãƒ¼ã‚«ãƒ«ã§å¤‰æ›´ãŒã™ãè©¦ã›ã‚‹ã€[Vercel](https://vercel.com)ã‚’ä½¿ãˆã°ãƒ‡ãƒ—ãƒ­ã‚¤ã¯pushã™ã‚‹ã ã‘ã§ã™ã‚€ã€‚
AWS lambdaã®å ´åˆã¯CDKã‚’ä½¿ã£ãŸ[serverlessui](https://github.com/JakePartusch/serverlessui)ã€[serverless-stack](https://github.com/serverless-stack/serverless-stack)ãªã©ãŒå‡ºã¦ãã¦ã„ã¾ã™ãŒã€ã‚„ã£ã±ã‚Šã¾ã ã²ã¨æ‰‹é–“ã‚ã‚‹æ„Ÿè§¦ã§ã™ã€‚

## [Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆ](https://www.google.com/intl/ja_jp/sheets/about/) + [Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/) + [Next.js](https://nextjs.org/)

```diff
- é™çš„ãªã‚¢ã‚»ãƒƒãƒˆ: Workers Sites(Workers + Workers KV)
+ é™çš„ãªã‚¢ã‚»ãƒƒãƒˆ: Next.js
- ãƒ­ã‚¸ãƒƒã‚¯: Workersã€Next.js API
+ ãƒ­ã‚¸ãƒƒã‚¯: Next.js API
KVS: Workers KV
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: Google spreadsheet
```

æœ€çµ‚çš„ãªãƒªãƒªãƒ¼ã‚¹æ™‚ã®æ§‹æˆã¯ã“ã†ãªã‚Šã¾ã—ãŸã€‚

[Next.js](https://nextjs.org/)([Vercel](https://vercel.com)) + [Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/) + [Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆ](https://www.google.com/intl/ja_jp/sheets/about/)ãªã®ã§æ™®é€šãªæ§‹æˆã«ãªã‚Šã¾ã—ãŸã€‚

<!-- https://excalidraw.com/#json=6647022375403520,Q3JfVDbtdxF3mt160wjy-w -->

![Next.js â†’ SpreadSheet + Workers KV](https://efcl.info/wp-content/uploads/2021/03/Next.js-Cloudflare-Workers-KV.png)

### é™çš„ãªã‚¢ã‚»ãƒƒãƒˆï¼ˆã‚µã‚¤ãƒˆï¼‰

Clouldflare WorkersãŒã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã§ã¯ãªã„ãªã‚‰ã€é™çš„ãªã‚¢ã‚»ãƒƒãƒˆã‚‚å˜ç´”ã«Next.jsã‚¢ãƒ—ãƒªã¨ã—ã¦Vercelã«ãƒ‡ãƒ—ãƒ­ã™ã‚Œã°ã„ã„ã ã‘ã«ãªã‚Šã¾ã™ã€‚
Clouddflareã¨Vercelã®[Vercel Edge](https://vercel.com/docs/edge-network/overview)ã‚’æ¯”ã¹ã‚‹ã¨Clouddflareã®æ–¹ãŒæ—©ãã§ãã‚‹ã‚±ãƒ¼ã‚¹ã¯å¤šã„ã§ã™ãŒã€Clouddflare Workersã¯ã¾ã ã¡ã‚‡ã£ã¨é›£ã—ã‹ã£ãŸã®ã§ãã“ã¯è«¦ã‚ã¾ã—ãŸã€‚
(Vercelã‚‚CDNã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè¼‰ã£ã¦ã‚‹ãªã‚‰30ms~100msãã‚‰ã„ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã›ã¾ã™)

UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã¯ã€Next.jsãªã®ã§Reactã¨[Chakra UI](https://chakra-ui.com/)ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
[Chakra UI](https://chakra-ui.com/)ã¯ç¨‹ã‚ˆã„ãƒãƒ©ãƒ³ã‚¹ã®CSS in JS(å†…éƒ¨çš„ã«ã¯[emotion](https://emotion.sh)ã‚’ä½¿ã†)ãªUIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

[xstyled](https://xstyled.dev/)ã‚„[React Spectrum](https://react-spectrum.adobe.com/)ã®ã‚ˆã†ã«ãƒ­ãƒ¼ãƒ¬ãƒ™ãƒ«ã§ã‚‚ãªãã€[Fluent UI](https://developer.microsoft.com/en-us/fluentui/)ã‚„[MATERIAL-UI](https://material-ui.com/)ã¿ãŸã„ãªãƒã‚¤ãƒ¬ãƒ™ãƒ«ã§ã‚‚ãªã„ãƒãƒ©ãƒ³ã‚¹ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚
ã‚µã‚¤ãƒˆã¨ãƒªãƒã‚¸ãƒˆãƒªã‚’æ¤œç´¢ã™ã‚Œã°ã€ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã ã„ãŸã„è¦‹ã¤ã‹ã£ãŸã®ã§æ‚ªãã¯ãªã‹ã£ãŸã‹ãªã¨æ€ã„ã¾ã™ã€‚

- [chakra-ui/chakra-ui: âš¡ï¸ Simple, Modular & Accessible UI Components for your React Applications](https://github.com/chakra-ui/chakra-ui/)

ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æŒ‡å®šã—ã¾ã™(CSS-in-JSãªã®ã§ã€ãã‚ŒãŒã‚¯ãƒ©ã‚¹ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã«å±•é–‹ã•ã‚Œã‚‹)ã€‚
marginã‚’`m`ã¨ã‹ãã†ã„ã†çŸ­ç¸®ã™ã‚‹ã®ã¯å¥½ãã˜ã‚ƒãªã„ã®ã§ã€`margin` propsã§æŒ‡å®šã—ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚
`base`ã§ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã«å¯¾å¿œã—ãŸã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‹ã‘ã‚‹ã®ã§ã€ãã“ã¾ã§æ·±ãæ„è­˜ã—ãªã„ã§ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªã‚µã‚¤ãƒˆã«ãªã‚Šã¾ã—ãŸã€‚

- [Responsive Styles - Chakra UI](https://chakra-ui.com/docs/features/responsive-styles)

ã‚¢ã‚¤ã‚³ãƒ³ã¯[React Icons](https://react-icons.github.io/react-icons)ã¨ã„ã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
ã„ã‚ã„ã‚ãªã‚¢ã‚¤ã‚³ãƒ³ã®é›†åˆä½“ã§ã€æ¢ã›ã°ã ã„ãŸã„ã‚ã‚‹ã®ã§ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚(ã‚¢ã‚¤ã‚³ãƒ³å€‹åˆ¥ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦importã™ã‚‹ã®ã§ã‚µã‚¤ã‚ºã‚‚å®‰å¿ƒã§ãã‚‹)

### KVS

æœ€åˆã«æ›¸ã„ã¦ã„ãŸã‚ˆã†ã«[Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/)ã¯Web APIã¨ã—ã¦å‘¼ã³å‡ºã›ã¾ã™ã€‚

[cloudflare-kv-storage-rest](https://github.com/markusahlstrand/cloudflare-kv-storage-rest)ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã¨ã€Cloudflare Workersã®[KV Storageã¨åŒã˜ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹](https://developers.cloudflare.com/workers/runtime-apis/kv)ã§ã€KVã®APIã‚’å©ã„ã¦KVSã¨ã—ã¦ä½¿ãˆã¾ã™ã€‚

[philan.net](https://philan.net/)ã§ã¯ã€ã“ã®[cloudflare-kv-storage-rest](https://github.com/markusahlstrand/cloudflare-kv-storage-rest)ã‚’ä½¿ã£ã¦æœ¬ç•ªã§ã¯Cloudflare Workers KVã‚’ä½¿ã£ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ™ãƒ¼ã‚¹ã«ã—ãŸ[ãƒ©ãƒƒãƒ‘ãƒ¼](https://github.com/azu/philan.net/blob/1ab224dc6961201b4d16c7c475fc6493a8f8a604/web/api-utils/kvs.ts)ã‚’ç”¨æ„ã—ã¦ä½¿ã£ã¦ã„ã¾ã™ã€‚
(KV Storageã®APIã¯Cloudflareã®API KeyãŒå¿…è¦ãªã®ã§ã€ä»–ã®äººãŒé–‹ç™ºã™ã‚‹ã“ã¨ã‚’è€ƒãˆã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯KV Storageã«ä¾å­˜ã—ãªã„ã‚ˆã†ã«ã—ãŸ)

ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¯ã¨ã‚Šã‚ãˆãšä»Šã¯[next-iron-session](https://github.com/vvo/next-iron-session)ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
(Pros, Consã‚ã‚‹ã®ã§ãªã‚“ã‹ã„ã„æ–¹æ³•ã‚’è¦‹ã¤ã‘ãŸã„ã€‚Serverless Redisã®[Upstash](https://upstash.com/)ã‚’ä½¿ã†ãªã©)

ğŸ“ ãƒã‚¿çš„ãªè©±ã§ã™ãŒã€ã“ã®[cloudflare-kv-storage-rest](https://github.com/markusahlstrand/cloudflare-kv-storage-rest)ã‚’ä½¿ã£ã¦expressã®sessionã‚’KV Storageã§ç®¡ç†ã™ã‚‹[express-session-cloudflare-kv](https://github.com/azu/express-session-cloudflare-kv)ã¨ã„ã†session storeã®å®Ÿè£…ã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚
ãŸã ã—ã€Cloudflare Workers KVã¯**çµæœæ•´åˆæ€§**ã§ã€ã“ã†ã„ã£ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã«ã¯å‘ã„ã¦ã„ãªã„ã®ã§productionã¨ã‹ã§ã¯ä½¿ãˆã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚(å®Ÿéš›ã«ä¸€åº¦readãŒã‚ã£ã¦ã‹ã‚‰åæ˜ ã•ã‚Œã¦ã‚‹ã‚ˆã†ãªæŒ™å‹•ãŒè¦‹ãˆãŸ)

ã“ã†ã„ã†ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒå¿…è¦ãªã‚‚ã®ã¯Durable Objectsã®æ–¹ãŒé©ã—ã¦ã„ã¾ã™ã€‚(ãã‚‚ãã‚‚Workerså†…ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†å‘ã„ã¦ãªã„ã¨ã¯æ€ã†ã‘ã©)

- [Workers Durable Objects Beta: A New Approach to Stateful Serverless](https://blog.cloudflare.com/introducing-workers-durable-objects/)

Durable Objectsã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯ã€æœ€è¿‘[CloudflareãŒè²·åã—ãŸLinc](https://blog.cloudflare.com/cloudflare-acquires-linc/)ã®ãƒ–ãƒ­ã‚°ãŒè‰¯ãæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

- [Durable Objects in Production - How Linc uses Cloudflare's new serverless real-time data platform | Blog | Linc](https://linc.sh/blog/durable-objects-in-production)

### ãƒ­ã‚¸ãƒƒã‚¯

Next.jsã®`api/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯Lambdaçš„ãªServerlessãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚
(å®Ÿéš›Vercelã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã¯AWS LambdaãŒã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚)

- [API Routes: Introduction | Next.js](https://nextjs.org/docs/api-routes/introduction)

[philan.net](https://philan.net/)ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã®Next.jsã®APIã«æ›¸ã„ã¦ã„ã¾ã™ã€‚

- <https://github.com/azu/philan.net/tree/main/web/pages/api>

[next-connect](https://github.com/hoangvvo/next-connect)ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã¨ã€express middlewareã‚‚å‹•ã‹ã›ã‚‹ã®ã§ã€
APIã®æ¨©é™ç®¡ç†ãªã©ã¯expressçš„ãªmiddlewareã¨ã—ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

ãŸã¨ãˆã°ã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¯[SpreadSheetã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹API](https://github.com/azu/philan.net/blob/1ab224dc6961201b4d16c7c475fc6493a8f8a604/web/pages/api/spreadsheet/add.ts)ã®å®Ÿè£…ã§ã™ã€‚

ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã™ã‚‹`withSession`ã¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹`requireLogin`ã‚’middlewareã¨ã—ã¦ãƒãƒ³ãƒ‰ãƒ©ã«ç½®ã„ã¦ã„ã¾ã™ã€‚

```ts
const handler = nextConnect<NextApiRequestWithUserSession, NextApiResponse>()
    .use(withSession())
    .use(requireLogin())
    .post(async (req, res) => {
        const { isoDate, amount, memo, to, url, currency, meta } = validateAddRequestBody(req.body);
        const user = req.user;
        const date = isoDate ?? new Date().toISOString();
        await addItem(...);
        res.json({
            ok: true
        });
    });

export default handler;
```

APIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯[create-validator-ts](https://github.com/azu/create-validator-ts)ã‚’æ›¸ã„ã¦ä½¿ã£ã¦ã„ã¾ã™ã€‚

- [azu/create-validator-ts: Create JSON Schema validator from TypeScript.](https://github.com/azu/create-validator-ts)

[create-validator-ts](https://github.com/azu/create-validator-ts)ã¯ã€TypeScriptã®å‹å®šç¾©ã‹ã‚‰JSON Schemaãƒ™ãƒ¼ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚(ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã¯ã‚«ã‚¹ã‚¿ãƒ ã§ãã¾ã™ãŒã€ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§OK)

- [api-types.ts](https://github.com/azu/philan.net/blob/1ab224dc6961201b4d16c7c475fc6493a8f8a604/web/pages/api/spreadsheet/api-types.ts): å‹å®šç¾©
- [api-types.validator.ts](https://github.com/azu/philan.net/blob/1ab224dc6961201b4d16c7c475fc6493a8f8a604/web/pages/api/spreadsheet/api-types.validator.ts): ç”Ÿæˆã•ã‚ŒãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

å…ˆç¨‹ã®`validateAddRequestBody`ã¨ã„ã†ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã¯ã€ã“ã®`api-types.ts`ã®å‹å®šç¾©ã‹ã‚‰è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹å®šç¾©ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ã‚‚å‚ç…§ã§ãã‚‹ã®ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒã®APIã®ã‚„ã‚Šå–ã‚ŠãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚

`api-types.ts`ã«å®šç¾©ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆBodyã®å‹ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã§ã¯[ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®bodyã¨ãªã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ](https://github.com/azu/philan.net/blob/bf55f1501277e3f945c64394d994153670d5cf53/web/pages/philan/add.tsx#L215-L226)ã§å‚ç…§ã—ã¦ã„ã¾ã™ã€‚

```ts
export type AddRequestBody = Omit<RecordItem, "date"> & {
    isoDate: string; // iso date
    currency: string;
};
```

TypeScriptã‚’æ›¸ã„ã¦ã„ã‚‹ã ã‘ã§ã€APIã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚Runtime/Compile timeã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ãŠã™ã™ã‚ã§ã™ã€‚

#### SpreadSheet

[philan.net](https://philan.net/)ã®ç‰¹å¾´çš„ãªã¨ã“ã‚ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¨©é™ã§ä½œæˆã—ãŸGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã‚‹ã¨ã“ã‚ã§ã™ã€‚

ã“ã‚Œã«ã‚ˆã£ã¦[philan.net](https://philan.net/)ãŒæ¶ˆæ»…ã—ã¦ã‚‚ã€ä»Šã¾ã§è¨˜éŒ²ã—ãŸå¯„ä»˜ã®ãƒ‡ãƒ¼ã‚¿ã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã«æ®‹ã‚Šã¾ã™ã€‚
æ…ˆå–„æ´»å‹•ã¯åŸºæœ¬çš„ã«é•·æœŸçš„ãªã‚‚ã®ãªã®ã§ã€ã“ã†ã„ã£ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¡ˆã¯æœ€åˆã‹ã‚‰ã‚ã£ãŸæ–¹ãŒã„ã„ã¨æ€ã£ã¦ã“ã†ãªã‚Šã¾ã—ãŸã€‚

Next.js APIã‹ã‚‰Google SpreadSheetã®æ›´æ–°ã¯å…¬å¼ã®[Google APIs Node.js Client](https://github.com/googleapis/google-api-nodejs-client)ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
ãŸã ã€SpreadSheetã®æ›´æ–°ã¯ã‹ãªã‚Šç›´æ„Ÿçš„ã«ã¯æ›¸ã‘ãªã„ã®ã§ã€ã‚‚ã£ã¨ã„ã„ãƒ©ãƒƒãƒ‘ãƒ¼ãŒã»ã—ã„ã§ã™ã€‚
SpreadSheetã®æœ«å°¾1è¡Œè¿½åŠ ã™ã‚‹ã ã‘ã§ã‚‚ã€ã‹ãªã‚Šé•·ã„batchUpdateã®å‡¦ç†ãŒå¿…è¦ã§ã™ã€‚

- https://github.com/azu/philan.net/blob/1ab224dc6961201b4d16c7c475fc6493a8f8a604/web/pages/api/spreadsheet/add.ts#L43-L104

ç‰¹å®šã®ã‚»ãƒ«ã ã‘ã‚’æ›´æ–°ã™ã‚‹ã¨ã‹ãã†ã„ã†ã®ã‚‚çµæ§‹é¢å€’ãªæ°—ãŒã—ã¾ã™ã€‚

SpreadSheetã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¤ã¨ã„ã†é€æ˜æ€§ãŒã„ã„æ„Ÿã˜ã«æ‹…ä¿ã§ãã¾ã™ãŒã€
ã“ã‚Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã®ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒçµæ§‹é¢å€’ã«ãªã‚‹ã¨ã„ã†æ€§è³ªã‚‚æŒã£ã¦ã„ã¾ã™ã€‚
(ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨åŒã˜ã‚ˆã†ãªé¢å€’ãã•ã•ã¯å‡ºã¦ãã‚‹ã¨æ€ã„ã¾ã™)

#### Next.js ISR + SpreadSheet

SpreadSheetã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚

- [azu - philan.net](https://philan.net/user/azu)

ã“ã‚Œã¯ã€Next.js + Vercelã®[Incremental Static Regeneration](https://nextjs.org/docs/basic-features/data-fetching#incremental-static-regeneration)(ISR)ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€åŸºæœ¬çš„ã«è¨ªå•ã™ã‚‹äººã«ã¯ä¸€ç¬ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
(ä¸€å®šæ™‚é–“çµŒã£ãŸã‚‰ãƒãƒƒã‚¯ã‚°ãƒ©ãƒ³ãƒ‰ã§SpreadSheetã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šç›´ã—ã¦å†ç”Ÿæˆã‚’ã™ã‚‹ãŸã‚ã€ãã®é–“ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¡¨ç¤ºã§ãã‚‹)

- https://github.com/azu/philan.net/blob/1ab224dc6961201b4d16c7c475fc6493a8f8a604/web/pages/user/%5BuserId%5D/index.tsx#L263-L275

ãŸã ã€Vercelã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ISRã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥(å®Ÿæ…‹ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ•ã‚¡ã‚¤ãƒ«)ãŒæ¶ˆãˆã‚‹ã®ã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤ç›´å¾Œã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç”Ÿæˆã—ç›´ã—ã¨ãªã‚‹ã®ãŒã‚¤ãƒã‚¤ãƒãªæ°—ãŒã—ã¾ã™ã€‚
Cloudflare Workers KVã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚³ã‚³ã«æŒŸã‚€å¿…è¦ã¨ã‹ã‚‚ãã®ã†ã¡å‡ºã¦ãã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

Next.jsã®ISRã‚„Cloudflare Workersã¯ã“ã†ã„ã£ãŸåˆ¥ã®å ´æ‰€ã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ãªãŒã‚‰è¡¨ç¤ºã™ã‚‹ã‚ˆã†ãªãƒ—ãƒ­ã‚­ã‚·çš„ãªå‡¦ç†ã«ã¯ã‹ãªã‚Šå‘ã„ã¦ã„ã‚‹æ„Ÿã˜ãŒã—ã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ãã®ã§ã€æ¯å›SpreadSheetã®APIã‚’å©ãå¿…è¦ã‚‚ãªã„ã—ã€ç¢ºå®Ÿã«æœ€æ–°ã®çŠ¶æ…‹ãŒè¡¨ç¤ºã™ã‚‹å¿…è¦ãŒãªã„å ´åˆã¯ã‚³ã‚¹ãƒ‘ã‚ˆãç®¡ç†ã§ãã¾ã™ã€‚
(Cloudflare Workers + Cloudflare Workers KVã®å ´åˆã¯ã€Cacheã®purgeã‚‚ä¸€ç¬ãªã®ã§ã‚ˆã‚Šç´°ã‹ãã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ã€‚Next.jsã®ISRã¯æ˜ç¤ºçš„ã«Cacheã‚’æ¶ˆã™[æ­£å¼ãªæ–¹æ³•](https://github.com/vercel/next.js/discussions/22384)ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚)

Read Onlyãªãƒšãƒ¼ã‚¸ã¯Vercelã®Cacheã«è¼‰ã£ã¦ã„ã‚‹ã®ã§ã€ã ã„ãŸã„100msä»¥ä¸‹ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§è¿”ã›ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

![Vercelã®Analytics](https://efcl.info/wp-content/uploads/2021/03/12-1615558509.png)

> [Analytics - Vercel Documentation](https://vercel.com/docs/next.js/analytics)

![Lighthouse](https://efcl.info/wp-content/uploads/2021/03/12-1615558538.png)

> [Lighthouse ã«ã‚ˆã‚‹ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®ç›£æŸ» Â |Â  Tools for Web Developers Â |Â  Google Developers](https://developers.google.com/web/tools/lighthouse?hl=ja)


## ãƒ­ã‚°

Vercelã«ã¯CloudWatchã®ã‚ˆã†ãªãƒ­ã‚°ç®¡ç†ã®ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚(ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªFunctionã®ãƒ­ã‚°ã—ã‹è¦‹ãˆãªã„)
ãã®ãŸã‚ãƒ­ã‚°ã®æ°¸ç¶šåŒ–ã¯Logflareã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

- [Logflare - Integrations â€“ Vercel](https://vercel.com/integrations/logflare)
- [Logflare | Cloudflare, Vercel & Elixir Logging](https://logflare.app/)

ãã“ã¾ã§ä½¿ã„ã‚„ã™ã„ã¨ã¯è¨€ãˆãªã„æ°—ã‚‚ã™ã‚‹ã®ã§ã€åˆ¥ã®ã‚‚ã®ã«ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## ãŠã‚ã‚Šã«

[philan.net](https://philan.net/)ã®æŠ€è¡“çš„ãªã‚¹ã‚¿ãƒƒã‚¯ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ã¾ã ä½œã£ã¦ã‹ã‚‰æ•°æ—¥ã—ã‹çµŒã£ã¦ãªã„ã§ã™ãŒã€ã¾ã‚ã¾ã‚ã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

æŠ€è¡“çš„ã«ã¯[Next.js](https://nextjs.org/) + [Vercel](https://vercel.com) + [Cloudflare Workers KV](https://www.cloudflare.com/ja-jp/products/workers-kv/) + [Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆ](https://www.google.com/intl/ja_jp/sheets/about/)ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚‚ç™»éŒ²ã—ã¦ãªã„çŠ¶æ…‹ãªæ°—ã‚‚ã™ã‚‹ã®ã§ã€å¤šåˆ†é‹å–¶è²»ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ä»£é‡‘ã‚’é™¤ã‘ã°0å††ã§ã™ã‚€ã¨æ€ã„ã¾ã™ã€‚
(ä¸€å¿œå„ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚‚Limitã¯ã‚ã‚Šã¾ã™ãŒã€çµæ§‹ç·©ã‚ãªã®ã§ãã“ã¾ã§åˆ°é”ã—ãªã„æ°—ã‚‚ã—ã¾ã™)

ãƒ‰ãƒ¡ã‚¤ãƒ³ä»£é‡‘ã‚’æ”¯æ´ã—ãŸã„äººã¯[GitHub Sponsors](https://github.com/sponsors/azu)ã§ã‚µãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚

<iframe src="https://github.com/sponsors/azu/button" title="Sponsor azu" height="35" width="116" style="border: 0;"></iframe>

- [Sponsor @azu on GitHub Sponsors](https://github.com/sponsors/azu)

GitHub Sponsorsã¿ãŸã„ãªã‚µãƒãƒ¼ãƒˆã‚‚[philan.net](https://philan.net/)ã«è¨˜éŒ²ã—ã¦å…¬é–‹ã™ã‚‹ã®ã‚‚è‰¯ã•ãã†ã§ã™ã€‚
ã“ã†ã„ã£ãŸå®šå¸¸çš„ãªå¯„ä»˜ã‚’ã¤ã‘ã‚‹ä»•çµ„ã¿ãŒã¾ã ãªã„ã®ã§ã€ä»Šå¾Œå®Ÿè£…ã—ã¦ã„ãäºˆå®šã§ã™ã€‚

- [Add subscription type like monthly? Â· Issue #8 Â· azu/philan.net](https://github.com/azu/philan.net/issues/8)
    - Google Apps Scriptï¼ˆGASï¼‰ã§å®Ÿè£…ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãŒã€cronçš„ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§æ‚©ã‚“ã§ã„ã‚‹

[philan.net](https://philan.net/)ã¯ã€ã¾ã ä½œã£ãŸã°ã‹ã‚Šã§ã™ãŒã€å°‘ãªãã¦ã‚‚ã‚„ã‚‹ã“ã¨ã¯ã‚ã‚‹ã®ã§å°‘ã—ãšã¤ä½œã£ã¦ã„ãã¾ã™ã€‚

ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãªã®ã§ã€Contributorã‚‚å¾…ã£ã¦ã„ã¾ã™ï¼(å¤šåˆ†ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ç™ºã§ãã‚‹ã¨æ€ã„ã¾ã™ãŒè‡ªä¿¡ã¯ãªã„ã®ã§ãã®è¾ºIssueä½œã£ã¦ãã ã•ã„)

- [azu/philan.net: Public Donation Management tool for Philanthropist.](https://github.com/azu/philan.net)

æœ€å¾Œã«ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚´ãƒ¼ãƒ«ãŒãƒ¡ãƒ¢ã«æ›¸ã„ã¦ã‚ã£ãŸã®ã§ãã‚Œã‚’è²¼ã‚Šä»˜ã‘ã¦çµ‚ã‚ã‚Šã§ã™ã€‚

## ã‚´ãƒ¼ãƒ«(ä»®)

- è‡ªåˆ†ã®å¯„ä»˜ã®çŠ¶æ³ã‚’å…¬é–‹ã™ã‚‹ã“ã¨ã§ã€é€æ˜æ€§ã‚’å‡ºã™(ã©ã£ã¡ã‚‚)
- å¯„ä»˜ã¯ç‰¹åˆ¥ãªã“ã¨ã§ã¯ãªã„çŠ¶æ…‹ã‚’ä½œã‚‹ã“ã¨

ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚´ãƒ¼ãƒ«

- è‡ªåˆ†ã®å¯„ä»˜ãŒå…¬é–‹ã§ãã‚‹(ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª)
- è‡ªåˆ†ã®å¯„ä»˜ã«é–¢é€£ã™ã‚‹æƒ…å ±ãŒå¾—ã‚‰ã‚Œã‚‹??
    - [å›½ç¨åºæ³•äººç•ªå·å…¬è¡¨ã‚µã‚¤ãƒˆ](https://www.houjin-bangou.nta.go.jp/) ã§æ¤œç´¢ã§ãã‚‹?
- GitHub Sponsorsã¨é€£æºã™ã‚‹/å®šæœŸçš„ãªå¯„ä»˜ç®¡ç†
- çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹
- å…¬é–‹ã—ãŸå¯„ä»˜ã‚’è¦‹ãŸäººãŒå¯„ä»˜ã‚’ã™ã‚‹
- å¯„ä»˜ã—ãŸã‚‚ã®ãŒè‡ªå‹•ã§è“„ç©ã•ã‚Œã‚‹