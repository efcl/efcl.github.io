---
title: "Almin 0.17ãƒªãƒªãƒ¼ã‚¹ â€“ executeã®å‹ä»˜ã‘ã€æ–°ã—ã„React Contextã®ã‚µãƒãƒ¼ãƒˆ"
author: azu
layout: post
date : 2018-06-11T19:18
category: JavaScript
tags:
    - Almin
    - JavaScript
    - library
    - React

---

ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®[almin@0.17.0](https://github.com/almin/almin/releases/tag/almin%400.17.0)ã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã—ãŸã€‚

è©³ã—ã„å¤‰æ›´ç‚¹ã¯æ¬¡ã®è¨˜äº‹ã§ã‚‚ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

- [Almin v0.17 â€“ Support `context.useCase#execute` typing and new React Context Â· Almin](https://almin.js.org/blog/2018/06/09/almin-0.17.html)

## â­ Feature

### Support `context.useCase#execute` typing [#342](https://github.com/almin/almin/issues/342) [#107](https://github.com/almin/almin/issues/107)

Alminã¯TypeScriptã‚’å…¬å¼ã«ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ä»Šã¾ã§ã¯`context.useCase(someUseCase).execute(args)`ã®`args`ãŒ`any[]`ã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚
ã‚³ãƒ¬ã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«[Almin 0.13](https://efcl.info/2017/07/24/almin-0.13/)ã§`context.useCase(someUseCase).executor(useCase => useCase.execute(args))`ã¨ã„ã†å‹ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ãŸã‚ã ã‘ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ã„ã¾ã—ãŸã€‚

ã—ã‹ã—ã€Almin 0.17ã§ã¯`context.useCase(someUseCase).execute(args)`ã‚‚å‹ãƒã‚§ãƒƒã‚¯ãŒã»ã¨ã‚“ã©ã®ã‚±ãƒ¼ã‚¹ã§åŠ¹ãã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

Almin 0.17+ã§ã¯æ¬¡ã®ã‚±ãƒ¼ã‚¹ã§å‹ãƒã‚§ãƒƒã‚¯ãŒåŠ¹ãã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã®ä¾‹ã§ã¯`MyUseCaseA.prototype.execute`ã«`string`å‹ã§ã¯ãªã„å€¤ã‚’æ¸¡ã™ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

```ts
import { UseCase, Context } from "almin";
class MyUseCaseA extends UseCase {
    execute(text: string) {}
}
const context = new Context({
    store: createStore({ name: "test" })
});

// valid
context.useCase(new MyUseCaseA()).execute("A");
// invalid
context.useCase(new MyUseCaseA()).execute(); // no argument
context.useCase(new MyUseCaseA()).execute(1); // can not pass number
context.useCase(new MyUseCaseA()).execute(1, 2); // can not pass number
```

Almin 0.17ã®`execute()`ã®å‹ãƒã‚§ãƒƒã‚¯ã¯ã¾ã ä¸å®Œå…¨ãªéƒ¨åˆ†ãŒã‚ã‚Šã€æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã•ã‚ŒãŸä»®å¼•æ•°ã‚ˆã‚Šã‚‚å¤šã„å¼•æ•°ã‚’æ¸¡ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚

```ts
import { UseCase, Context } from "almin";
class MyUseCaseA extends UseCase {
    execute(text: string) {}
}
const context = new Context({
    store: createStore({ name: "test" })
});
// **valid in almin 0.17**
context.useCase(new MyUseCaseA()).execute("A". 42);
```

### Conditional Typesã‚’ä½¿ã£ãŸå®Ÿè£…

ã“ã®`execute()`ã®å‹ãƒã‚§ãƒƒã‚¯ã¯TypeScript 2.8ã§è¿½åŠ ã•ã‚ŒãŸ[Conditional types](https://blogs.msdn.microsoft.com/typescript/2018/03/27/announcing-typescript-2-8/#conditional-types)ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

ã¾ãšã€é–¢æ•°ã®å¼•æ•°ã®å€¤ã®å‹ã‚’Tupleã¨ã—ã¦è¿”ã™type functionã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```ts
type A0<T> = T extends () => any
    ? any : never
type A1<T> = T extends (a1: infer R1) => any
    ? [R1] : [never]
type A2<T> = T extends (a1: infer R1, a2: infer R2) => any
    ? [R1, R2] : [never, never]
type A3<T> = T extends (a1: infer R1, a2: infer R2, a3: infer R3) => any
    ? [R1, R2, R3] : [never, never, never]
```

ã‚³ãƒ¬ã‚’ä½¿ãˆã°æ¬¡ã®ã‚ˆã†ã«`fn`é–¢æ•°ã®1ç•ªç›®ã®å¼•æ•°ã®å‹ã‚’å«ã‚€Tupleã‚’å–å¾—ã§ãã¾ã™ã€‚
`fn`é–¢æ•°ã®ä¸€ç•ªã®å¼•æ•°ã¯`string`å‹ãªã®ã§`[string]`ãŒæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚

```ts
type A1<T> = T extends (a1: infer R1) => any
    ? [R1] : [never]

function fn(a1: string){

}

type FnArgs = A1<typeof fn>;
// [string]
```

- [TypeScript playground](https://agentcooper.github.io/typescript-play/#code/C4TwDgpgBAggjAHgCoD4oF4pKhAHsCAOwBMBnKACgEM4AuKAS0IDMIAnKAJTgEoM0qhEACgoYqAH4oAbW4BdKPWmEIAN3Zzhw5gFdCAY2AMA9oSjNC1OlFLA2TAOY8A3loC+W0JCgAxQjDYHckx4BC8IY2ZzQhQAbmEAegSZW3tCBzkgA)

`context.useCase(someUseCase).execute(args)`ã®`someUseCase#execute`ã®å¼•æ•°ã®å‹ã‚’å–å¾—ã™ã‚‹ã®ãŒç›®çš„ã§ã™ã€‚
Alminã§ã¯`UseCaseExecutor`(`context.useCase`ã¯ã“ã‚Œã‚’ä½œã£ã¦è¿”ã™)ã¨ã„ã†UseCaseã®å®Ÿè¡Œãƒ©ãƒƒãƒ‘ãƒ¼ã‚’çµŒç”±ã—ã¦UseCaseã‚’å®Ÿè¡Œã—ã¾ã™(ãƒ­ã‚°ãªã©ã‚’å–ã‚‹ãŸã‚)

ãã®ãŸã‚ã€`UseCaseExecutor#excute(args)`ã®`args`ãŒ`someUseCase#execute(args)`ã®`args`ã¨åŒã˜å‹ã§ã‚ã‚Œã°ã‚ˆã„ã¯ãšã§ã™ã€‚

ã•ãã»ã©å®šç¾©ã—ãŸ`A0`...`A3`(å®Ÿéš›ã¯`A9`ã¾ã§ã‚ã‚Šã¾ã™)ã‚’ä½¿ã£ã¦ã€ã²ãŸã™ã‚‰å‹ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹å®šç¾©ã‚’`execute`ã«è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

```ts
class UseCaseExecutor<T extends UseCase> {
    useCase: T;

    constructor(useCase: T) {
        this.useCase = useCase;
    }

    // `this: never` aim to throw error when no arguments with argumented required `execute`
    execute<P extends A0<T["execute"]>, K>(this: P extends never ? never : this): Promise<void>;
    execute<P extends A1<T["execute"]>>(a1: P[0]): Promise<void>;
    execute<P extends A2<T["execute"]>>(a1: P[0], a2: P[1]): Promise<void>;
    execute<P extends A3<T["execute"]>>(a1: P[0], a2: P[1], a3: P[2]): Promise<void>;
    execute(...args: any[]): Promise<void> {
        return this.useCase.execute(...args);
    }
}
```

ã“ã®ã‚ˆã†ãªçµæ§‹ç„¡ç†ã‚„ã‚Šãªå®Ÿè£…ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§`execute`ã‚‚å‹ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚‹ç¨‹åº¦åŠ¹ãã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

æœ¬æ¥ã¯[Variadic Kinds](https://github.com/Microsoft/TypeScript/issues/5453)ãªã©ãŒã‚ã‚‹ã¨ã“ã®ã‚ˆã†ãªãƒ©ãƒƒãƒ‘ãƒ¼ã®å‹ã‚’å®šç¾©ã§ãã‚‹ã¿ãŸã„ã§ã™ãŒã€ã¾ã TypeScriptã«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

è©³ã—ãã¯æ¬¡ã«ã‚‚æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€èˆˆå‘³ãŒã‚ã‚‹/ã‚‚ã£ã¨ã„ã„æ–¹æ³•ã‚’çŸ¥ã£ã¦ã‚‹äººã¯[è©²å½“Issue](ttps://github.com/almin/almin/issues/107#issuecomment-384993458)ã«ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„ã€‚

- [almin-thinking/04-Conditional-UseCase.ts at master Â· almin/almin-thinking](https://github.com/almin/almin-thinking/blob/master/02-UseCase/04-Conditional-UseCase.ts "almin-thinking/04-Conditional-UseCase.ts at master Â· almin/almin-thinking")
- [almin/UseCaseExecutor.ts at master Â· almin/almin](https://github.com/almin/almin/blob/master/packages/almin/src/UseCaseExecutor.ts "almin/UseCaseExecutor.ts at master Â· almin/almin")


## â™» Improving

###  use `assertOK` instead of `assert` module [#341](https://github.com/almin/almin/issues/341)

`assert`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å˜ç´”ãªUtilã«ç½®ãæ›ãˆãŸã“ã¨ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ããªã£ã¦ã„ã¾ã™ã€‚

â¬‡ï¸ 4kb

#### Before

> Package size: 12.55 KB

#### After

> Package size: 8.27 KB


é–¢é€£Issueã¨ã—ã¦ã¯`events`ã®ä¾å­˜ã‚‚å–ã‚Šé™¤ãã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

- [Drop to use `events` Â· Issue #352 Â· almin/almin](https://github.com/almin/almin/issues/352)

React Nativeã§ã¯webpackã‚„browserifyã®ã‚ˆã†ã«`assert`ãªã©ã®Nodeã‚³ã‚¢APIãŒè‡ªå‹•ã§shimã«åˆ‡ã‚Šæ›¿ã‚ã‚‰ãªã„ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚
ã¾ãŸ[Nodeã‚³ã‚¢APIã¨ãƒ–ãƒ©ã‚¦ã‚¶ã®shimã®ä¹–é›¢](https://github.com/azu/node-browser-shim-gap)ã—ã¦ã„ã‚‹å•é¡Œã‚‚ç›®ç«‹ã£ã¦ããŸã®ã§ã€`events`ã‚„`assert`ã®ä¾å­˜ã¯å¤–ã™ã‹æ˜ç¤ºçš„ãªã‚‚ã®ã«å¤‰ãˆã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

## ğŸ†• New Modules

### [@almin/react-context](https://github.com/almin/almin/tree/master/packages/%40almin/react-context) [#346](https://github.com/almin/almin/issues/346) [#112](https://github.com/almin/almin/issues/112)

[@almin/react-context](https://github.com/almin/almin/tree/master/packages/%40almin/react-context)ã¨ã„ã†Reactãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

åå‰ã®é€šã‚ŠReact 16.3ã§è¿½åŠ ã•ã‚ŒãŸæ–°ã—ã„[React Context API](https://reactjs.org/docs/context.html)ã«å¯¾å¿œã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚

åŸºæœ¬çš„ã«ã¯React Context APIã¨åŒã˜ã§ã™ãŒã€`<Consumer>`ã®ä¸­èº«ãŒå‘¼ã°ã‚Œã‚‹ã®ã¯Alminã®`Context`ãŒå¤‰åŒ–ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ãªã£ã¦ã„ã¾ã™ã€‚

```js
import { Context, StoreGroup } from "almin";
import { createStore } from "@almin/store-test-helper";
import { createReactContext } from "@almin/react-context";
// Create Almin context
const context = new Context({
    // StoreGroup has {a, b, c} state
    store: new StoreGroup({
        // createStore is a test helper that create Store instance of Almin
        // initial state of `a` is { value: "a" }
        a: createStore({ value: "a" }),
        b: createStore({ value: "b" }),
        c: createStore({ value: "c" }),
    })
});
// Create React Context that wrap Almin Context
const { Consumer, Provider } = createReactContext(context);
// Use Provider
class App extends React.Component {
    render() {
        return (
            // You should wrap Consumer with Provider
            <Provider>
                {/* Consumer children props is called when Almin's context is changed */}
                <Consumer>
                    {state => {
                        return <ul>
                            <li>{state.a.value}</li>;
                            <li>{state.b.value}</li>;
                            <li>{state.c.value}</li>;
                        </ul>
                    }}
                </Consumer>
            </Provider>
        );
    }
}
```

ã™ã§ã«Reactã¨ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã«ã¯HOCã‚’ä½¿ã£ãŸ[almin-react-container](https://github.com/almin/almin/tree/master/packages/almin-react-container)ãŒã‚ã‚Šã¾ã™ã€‚
ãŸã ã€React Context APIã®æ–¹ãŒãƒ¡ãƒ³ãƒ†ã—ã‚„ã™ã„ã¨æ€ã†ã®ã§ã€ä»Šå¾Œã©ã¡ã‚‰ã‹ã«(å…¬å¼ã‚µãƒãƒ¼ãƒˆ)çµã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ä½•ã‹æ„è¦‹ã‚„å•é¡Œãªã©ãŒã‚ã‚Šã¾ã—ãŸã‚‰ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚

ã“ã®å®Ÿè£…ã¯[ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ¤œç´¢PWA](https://hatebupwa.netlify.com/)ã§ä½¿ã£ãŸã‚‚ã®ãŒå…ƒã¨ãªã£ã¦ã„ã¦ã€ã™ã§ã«ã“ã¡ã‚‰ã®ã‚¢ãƒ—ãƒªã‚‚`@almin/react-context`ã«ç§»è¡Œã—ã¦ã„ã¾ã™ã€‚

- [ãƒ¢ãƒã‚¤ãƒ«/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œã™ã‚‹ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ¤œç´¢ã®PWAã‚’ä½œã£ãŸ | Web Scratch](https://efcl.info/2018/04/16/hatebupwa/)
- [Update to almin and use @almin/react-context by azu Â· Pull Request #12 Â· azu/hatebupwa](https://github.com/azu/hatebupwa/pull/12)


## éå»ã®å¤‰æ›´

### [almin@0.16.0](https://github.com/almin/almin/releases/tag/almin%400.16.0)

[almin@0.16.0](https://github.com/almin/almin/releases/tag/almin%400.16.0)ã§ã¯`Context`ã®`dispatcher`ãŒã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã«ãªã‚Šã¾ã—ãŸã€‚

```diff
const context = new Context({
-	dispatcher: new Dispatcher(),
	store: storeGroup
});
```