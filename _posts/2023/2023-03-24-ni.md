---
title: "npm/yarn/pnpm/bunを同じコマンドで扱える ni のzsh実装を書いた"
author: azu
layout: post
date : 2023-03-24T22:21
category: JavaScript
tags:
    - JavaScript
    - Node.js
    - zsh

---

`ni`というnpm/yarn/pnpm/bunを同じコマンドでインストール/アンストールコマンドを実行できるツールがあります。

- [antfu/ni: 💡 Use the right package manager](https://github.com/antfu/ni)

仕組み的には、各パッケージのロックファイルや[Corepack](https://nodejs.org/api/corepack.html)で決められた`packageManager`フィールドの値から、どのパッケージマネージャを使うかを判断しています。
たとえば、`package-lock.json`があるプロジェクトならnpmを使ってるので、`ni`コマンドはnpmのコマンドを実行します。
また、`packageManager`フィールドが`yarn@<version>`になっている場合は、`ni`コマンドはyarnコマンドを実行します。

なぜこういうツールが必要になるかというと、npmやyarnなどのパッケージマネージャは、それぞれのパッケージマネージャのコマンドが異なるためです。
たとえば、npmでは`npm install <pkg>`でパッケージを追加できますが、yarnでは`yarn add <pkg>`でパッケージを追加します。

色々なオープンソースプロジェクトをやっているとこのnpm/yarn/pnpm/bunなどがプロジェクトで異なるので、コマンドを意識して使い分ける必要が出てきて大変です。
`ni`はこれを`n?`というコマンド一つにまとめるというものです。

[antfu/ni](https://github.com/antfu/ni)を使うのも良いと思ったのですが、Node.jsである必要性もあんまりないのと、それぞれがコマンドとして実装されていて名前が被りそうな問題が気になりました。
たとえば、`npm run`に相当するのが`nr`で、`npm upgrade`に相当するのが`nu`という形になっています。

これだと、コマンドが増えると別のコマンドと被りそうなので、`ni run`のようにサブコマンドにした方がいいかなと思いました。

- [About `nix` - really reconsider renaming it · Issue #143 · antfu/ni](https://github.com/antfu/ni/issues/143)

そこで、zshで実装してみました。

## ni.zsh

実装は次のリポジトリにあります。

- [azu/ni.zsh: Alternative `ni` written in zsh](https://github.com/azu/ni.zsh)

1ファイルだけのシンプルなものなので、次のようにダウンロードして使うことができます。

```sh
curl https://raw.githubusercontent.com/azu/ni.zsh/main/ni.zsh > ni.zsh
source ni.zsh
```

あんまりzshスクリプトの適切な配布がわからないので、誰かがいい感じにしてくれると思います。

オリジナルの`ni`とは違って、サブコマンドとして実装しているので、`ni run`のようにサブコマンドを使うことができます。

```
ni                      -- install current package.json | npm install相当
ni add <pkg>            -- add package                  | npm install <pkg>相当
ni remove <pkg>         -- remove package　　　　　　　　　| npm uninstall <pkg>相当
ni run <script>         -- run scripts                  | npm run <script>相当
ni test                 -- run test script              | npm test相当
ni upgrade              -- upgrade packages             | npm upgrade相当
ni upgrade-interactive  -- upgrade package interactively| npmにはないのでnpm-check -uを使う
```

内部的には、ロックファイルと`packageManager`フィールドを見て、どのパッケージマネージャを使うかを判断するのは大体同じです。
`ni <Tab>` でサブコマンドをAuto Completeできるようになっています。

### Note

自分がYarn v2+を使ってるプロジェクトを持ってないので、Yarn v2+のプロジェクトは多分対応できてません。
また、pnpmとbunも結構適当に書いているので、実際に動いてるかはわかりません。この辺はPR待っています。

ライセンスはMITライセンスで、1ファイルなので自分の用途に合わせて加工して使ってもらっても大丈夫です。