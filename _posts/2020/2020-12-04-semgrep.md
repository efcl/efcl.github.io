---
title: "Semgrepã‚’ä½¿ã£ãŸæ§‹æ–‡æœ¨ãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ã¨ç½®æ›ã§ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’ã™ã‚‹"
author: azu
layout: post
date : 2020-12-04T10:03
category: JavaScript
tags:
    - JavaScript
    - AST
    - Tools

---

[Semgrep](https://semgrep.dev/)ã¨ã„ã†æ§‹æ–‡æœ¨ãƒ™ãƒ¼ã‚¹ã®grep/sedçš„ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ãŸãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’ã—ãŸè©±ã§ã™ã€‚

## [Semgrep](https://semgrep.dev/)

[Semgrep](https://semgrep.dev/)ã¯[r2c](https://r2c.dev/)ã¨ã„ã†ä¼šç¤¾/ã‚µãƒ¼ãƒ“ã‚¹ãŒé–‹ç™ºã—ã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
Semgrepã®ç‰¹å¾´ã¨ã—ã¦[Tree-sitter](https://tree-sitter.github.io/tree-sitter/)ã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ã‚¹ã—ãŸConcrete Syntax Tree(CST)ã®æ§‹æ–‡æœ¨ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦æ¤œç´¢ã‚„ç½®æ›ãŒã§ãã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã‚’CSTã«ãƒ‘ãƒ¼ã‚¹ã—ãŸæ§‹æ–‡æœ¨ã«å¯¾ã—ã¦æ¤œç´¢/ç½®æ›ã™ã‚‹ã“ã¨ã§ã€ãŸã ã®æ–‡å­—åˆ—æ¤œç´¢/ç½®æ›ã«æ¯”ã¹ã¦ãƒŸã‚¹ãƒãƒƒãƒã—ãªã„æ¤œç´¢/ç½®æ›ãŒã§ãã¾ã™ã€‚
ä¾‹ãˆã°ã€æ¬¡ã®a.jsã€b.jsã€c.jsã¯ãã‚Œãã‚Œ`eval`ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€ã‚¹ã‚¿ã‚¤ãƒ«ã¯é•ã„ã¾ã™ãŒæ„å‘³ã¯ã»ã¨ã‚“ã©åŒã˜ã§ã™ã€‚

```js
// a.js
eval("const a = 1, b = 2; eval(a + b);");
// b.js
eval('const a = 1, b = 2;\
eval(a + b);');
// c.js
eval(`const a = 1, b = 2;
eval(a + b);`);
```

ã“ã‚Œã‚‰ã«`eval(å¼•æ•°)`ã«ãƒãƒƒãƒã™ã‚‹æ­£è¦è¡¨ç¾ã‚’æ›¸ãã®ã¯çµæ§‹é›£ã—ã„ã§ã™ãŒã€Semgrepã§ã¯`eval(...)`ã¨ã„ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ¤œç´¢ã§ãã¾ã™ã€‚

```
$ semgrep --pattern 'eval(...)' --lang=js *
a.js
1:eval("const a = 1, b = 2; eval(a + b);");

b.js
1:eval('const a = 1, b = 2;\
2:eval(a + b);');

c.js
1:eval(`
2:const a = 1, b = 2;
3:eval(a + b);
4:`);

d.js
5:eval(userInput);
```

ã“ã®æ§‹æ–‡æœ¨ã‚’ä½¿ã£ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®æ¬ ç‚¹ã¨ã—ã¦ã¯ã€ãƒ‘ãƒ¼ã‚¹ã§ãã‚‹è¨€èªã—ã‹å¯¾å¿œã§ããªã„ç‚¹ã§ã™ãŒã€
[Semgrep](https://semgrep.dev/)ã¯Goã€Javaã€JavaScript/TypeScriptã€Pythonã€Rubyã€Ocamlã€PHPã€Cãªã©ä¸»è¦ãªè¨€èªã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯è¨€èªã”ã¨ã«ç•°ãªã‚‹)

- [Home - Semgrep Docs](https://semgrep.dev/docs/)

ã“ã®ã‚ã‚‹ç¨‹åº¦æŠ½è±¡åŒ–ã•ã‚ŒãŸãƒãƒƒãƒã¨ç½®æ›å‡¦ç†ã‚’ã‚ã‚ã›ã¦ã€ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’ã—ã¦ã„ãã¨ã„ã†ã®ãŒã“ã®è¨˜äº‹ã®ç›®çš„ã§ã™ã€‚

ğŸ“ ã“ã®è¨˜äº‹ã ã¨CST(Concrete Syntax Tree)ã¨AST(Abstract Syntax Tree)ã‚’ã‚ã¾ã‚ŠåŒºåˆ¥ã—ã¦ã¾ã›ã‚“ã€‚
CSTã¯ã‚¹ãƒšãƒ¼ã‚¹ãªã©ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã«æ„å‘³ãŒãªã„æƒ…å ±ã®ä½ç½®ã‚‚ã¡ã‚ƒã‚“ã¨æ§‹æ–‡æœ¨ã¨ã—ã¦æŒã¤ã¨ã„ã†ã®ãŒASTã¨ã®é•ã„ã¨ã—ã¦ã‚ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚(ASTã§ã‚‚tokençš„ã«æŒã£ã¦ã‚‹ã“ã¨ã¯ã‚ã‚‹æ°—ãŒã™ã‚‹)
å¤šåˆ†å…ƒã¨ãªã£ã¦ã‚‹[pfff](https://github.com/returntocorp/pfff/)ãŒOcamlã§æ›¸ã‹ã‚Œã¦ã¦[Tree-sitter](https://tree-sitter.github.io/tree-sitter/)ä½¿ã£ã¦ãŸã‹ã‚‰CSTã¨ã„ã†æ„Ÿã˜ãªã®ã‹ã‚‚ã€‚[r2c](https://r2c.dev/)ã¨ã‹ã¯Lintã¨ã‹ãã£ã¡ç³»ã®ã‚µãƒ¼ãƒ“ã‚¹ãªã®ã§ASTã‚ˆã‚Šã‚‚è©³ç´°ãªCSTãƒ¬ãƒ™ãƒ«ã®æƒ…å ±ãŒå¿…è¦ã«ãªã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚

## Semgrepã®åŸºæœ¬çš„ãªä½¿ã„æ–¹

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[Semgrep](https://github.com/returntocorp/semgrep)ã®READMEã«å¾“ã£ã¦å¥½ããªæ–¹æ³•ã§`semgrep`ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```
# For macOS
$ brew install semgrep

# For Ubuntu/WSL/Linux/macOS
$ python3 -m pip install semgrep

# To try Semgrep without installation run via Docker
$ docker run --rm -v "${PWD}:/src" returntocorp/semgrep --help
```

### CLI

ä¾‹ãˆã°ã€semgrepã‚’ä½¿ã£ã¦`eval()`ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã—ãŸã„å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ã™ã‚Œã°æ¤œç´¢ã§ãã¾ã™ã€‚

`eval(...)` ã¯ `eval` é–¢æ•°ã‚’0ã‚³ä»¥ä¸Šã®å¼•æ•°ã§å‘¼ã³å‡ºã—ã¦ã„ã‚‹ç®‡æ‰€ã«ãƒãƒƒãƒã—ã¾ã™ã€‚

```js
$ semgrep --pattern 'eval(...)' --lang=js *.js
more information.
a.js
1:eval("const a = 1, b = 2; eval(a + b);");

b.js
1:eval('const a = 1, b = 2;\
2:eval(a + b);');

c.js
1:eval(`
2:const a = 1, b = 2;
3:eval(a + b);
4:`);
ran 1 rules on 3 files: 3 findings
```

æ–‡å­—åˆ—æ¤œç´¢ã¨é•ã£ã¦ã€ã‚¯ã‚ªãƒ¼ãƒˆã®é•ã„ã‚„æ–‡å­—åˆ—æœ«å°¾ã§ã®`\`ã®æ‰±ã„ãªã©ã‚’å¸åã—ã¦æ¤œç´¢ã§ãã¦ã„ã¾ã™ã€‚
ã¾ãŸã€`eval`é–¢æ•°ã®ä¸­ã«æ›¸ã‹ã‚ŒãŸæ–‡å­—åˆ—ã®`eval(a + b)`é–¢æ•°ã«ã¯ãƒãƒƒãƒã—ã¦ãªã„ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¯`if($X){ ... }` ã§ifæ–‡ã¨ãƒ–ãƒ­ãƒƒã‚¯ã¸ã®ãƒãƒƒãƒã¨ã„ã£ãŸè¡¨ç¾ã‚‚ã§ãã¾ã™ã€‚
(ã“ã® `$X` ã¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ç½®æ›æ™‚ã«ã‚‚åˆ©ç”¨ã§ãã¾ã™)

`requests.get("=~/dev\./i")` ã®ã‚ˆã†ã«æ­£è¦è¡¨ç¾ã‚’çµ„ã¿åˆã‚ã›ãŸãƒãƒƒãƒã‚‚ã§ãã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã®è¦‹ãŸç›®ã«è¿‘ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãŒã§ãã‚‹ã®ãŒç‰¹å¾´ã§ã™ã€‚

è©³ã—ãã¯æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§è§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚

- [Pattern syntax - Semgrep Docs](https://semgrep.dev/docs/writing-rules/pattern-syntax/)

### Config

Semgrepã§ã¯yamlå½¢å¼ã§æ›¸ã„ãŸconfigãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦ã€è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„ã‚‚ã£ã¨è¤‡é›‘ãªçµ„ã¿åˆã‚ã›ã‚‚è¡¨ç¾ã§ãã¾ã™ã€‚

ãŸã¨ãˆã°ã€æ¬¡ã®ã‚ˆã†ã«`eval`é–¢æ•°ã®å¼•æ•°ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã®å ´åˆã¯å•é¡Œãªã„ã®ã§ç„¡è¦–ã—ãŸã„ã‘ã©ã€
`eval`é–¢æ•°ã®å¼•æ•°ãŒå¤‰æ•°(ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‹ã‚‚ã—ã‚Œãªã„)å ´åˆã¯è‰¯ããªã„ã®ã§ã€
ãã®ã‚ˆã†ãªç®‡æ‰€ã‚’è¦‹ã¤ã‘ãŸã„ã¨ã—ã¾ã™ã€‚

```js
// OK
eval("1+1");
// NG
eval(userInputVariable);
```

ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¯å…ˆã»ã©ã‚‚ã¤ã‹ã£ãŸ `eval(...)` ã§`eval`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ç®‡æ‰€ãŒè¦‹ã¤ã‘ã‚‰ã‚Œã¾ã™ã€‚
ã“ã®ãƒãƒƒãƒçµæœã‹ã‚‰ `eval("...")` ã§ã®ãƒãƒƒãƒçµæœã‚’é™¤å¤–ã™ã‚Œã°æ±‚ã‚ã‚‹`eval`é–¢æ•°ã«å¤‰æ•°ã‚’æ¸¡ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒè¦‹ã¤ã‘ã‚‰ã‚Œãã†ã§ã™ã€‚

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¬¡ã®ã‚ˆã†ã«`pattern`ã¨`pattern-not`ã®çµ„ã¿åˆã‚ã›ã§è¡¨ç¾ã§ãã¾ã™ã€‚

```yml
rules:
- id: insecure-eval-use
  patterns:
  - pattern: eval(...)
  - pattern-not: eval("...")
  message: Calling 'eval' with user input
  languages: [javascript]
  severity: WARNING
```

`semgrep --config` ã§ã“ã®config fileã‚’æŒ‡å®šã™ã‚Œã°ã€ãã®ãƒ«ãƒ¼ãƒ«ã§æ¤œç´¢ã§ãã¾ã™ã€‚

```
$ semgrep --config ./semgrep.yml
running 1 rules...
d.js
severity:warning rule:insecure-eval-use: Calling 'eval' with user input
5:eval(userInput);
ran 1 rules on 4 files: 1 findings
```

semgrepã®configã«ã¯ãƒãƒƒãƒã—ãŸã¨ãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„`severity`ãªã©ãŒæŒ‡å®šã§ãã‚‹ã®ã§ã€ESLintãªã©ã®ã‚ˆã†ãªLintãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ä½¿ã†ã“ã¨ã‚‚ç›®çš„ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¯ã€ANDã‚„ORã€ç‰¹å®šã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å†…å´ã€å¤–å´ã¨ã„ã£ãŸã„ã‚ã„ã‚ãªè¡¨ç¾ãŒã§ãã‚‹ã®ã§çµæ§‹æŸ”è»ŸãªãƒãƒƒãƒãŒã§ãã¾ã™ã€‚
ã¾ãŸã€[pattern-regex](https://semgrep.dev/docs/writing-rules/rule-syntax/#pattern-regex)ã¨ã„ã†æ­£è¦è¡¨ç¾ã§ã®ãƒãƒƒãƒã‚‚ã§ãã‚‹ã®ã§ã‹ãªã‚Šè‡ªç”±ã§ã™ã€‚

è©³ã—ãã¯ãƒ«ãƒ¼ãƒ«ã®æ§‹æ–‡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§è§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚

- [Rule syntax - Semgrep Docs](https://semgrep.dev/docs/writing-rules/rule-syntax/)

## Semgrepã§ç½®æ›

[Semgrep](https://github.com/returntocorp/semgrep)ã¯æ¤œç´¢ã ã‘ã§ã¯ãªãã¦ã€ãƒãƒƒãƒå†…å®¹ã®ç½®æ›ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
2020-12-04æ™‚ç‚¹ã§ã¯Experimentalãªã®ã§ä¸Šæ‰‹ãç½®æ›ã§ããªã„ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚Šã¾ã™ã€‚

- [Experiments ğŸ§ª - Semgrep Docs](https://semgrep.dev/docs/experiments/overview/)

ä¾‹ãˆã°ã€`eval(...)` ã‚’ `new Function(...)` ã«ç½®æ›ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ãŸã„å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚
`...` ã¯ãƒãƒƒãƒã™ã‚‹ã ã‘ãªã®ã§ã€`$X` ã®ã‚ˆã†ã«`$ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ` ã‚’å¤‰æ•°ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚
ã“ã®å¤‰æ•°ã‚’ç½®æ›å¾Œã® `fix:` ã«å…¥ã‚Œã‚Œã°ã€å…ƒã®ãƒãƒƒãƒå†…å®¹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ç½®æ›ã«ä½¿ãˆã¾ã™ã€‚

```yaml
rules:
  - id: use-new-function
    languages:
      - javascript
    message: |
      Use `new Function` instead of `eval`
    pattern: eval($X)
    fix: new Function($X)
    severity: WARNING
```

ç½®æ›ã‚’ã™ã‚‹å ´åˆã¯`--autofix`ã¨ã„ã†å¼•æ•°ã¨ã¨ã‚‚ã«å‘¼ã³å‡ºã™ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãæ›ãˆã¦ãã‚Œã¾ã™ã€‚

```
$ semgrep --config fix.yml --autofix d.js --verbose
running 1 rules...
successfully modified 1 file.
d.js
severity:warning rule:use-new-function: Use `new Function` instead of `eval`

5:new Function(userInput)
autofix: new Function(userInput)
ran 1 rules on 1 files: 1 findings
```

ã“ã®autofixæ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’ã—ãŸã¨ã„ã†ã®ãŒæœ¬é¡Œã§ã™ã€‚

## [Semgrep](https://github.com/returntocorp/semgrep)ã§ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

ã“ã“ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚ã‚‹ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®æœ¬é¡Œã§ã™ã€‚

[HonKit](https://github.com/honkit/honkit)ã¨ã„ã†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„æ›¸ç±ã‚’ä½œæˆãƒ„ãƒ¼ãƒ«ã‚’ã¤ãã£ã¦ã„ã¾ã™ã€‚

- [GitBookã‚’Forkã—ã¦HonKitã‚’ä½œã‚Šã¾ã—ãŸ | Web Scratch](https://efcl.info/2020/06/19/githon/)

HonKitã®Forkå…ƒã§ã‚ã‚‹GitBookã¯JavaScriptã§æ›¸ã‹ã‚Œã¦ã„ãŸã®ã§ã™ãŒã€HonKitã§ã¯ã‚³ãƒ¼ãƒ‰ã‚’ãƒ™ãƒ¼ã‚¹ã‚’TypeScriptã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã—ãŸã€‚
JavaScriptã‹ã‚‰TypeScriptã¸ã®ç§»è¡Œã¯[ts-migrate](https://github.com/airbnb/ts-migrate)ã¨[commonjs-to-es-module-codemod](https://github.com/azu/commonjs-to-es-module-codemod)ã‚’ä½¿ã„ã»ã¼æ©Ÿæ¢°çš„ã«è¡Œã„ã¾ã—ãŸã€‚

- [refactor(honkit): Convert JavaScript to TypeScript by azu Â· Pull Request #112 Â· honkit/honkit](https://github.com/honkit/honkit/pull/112)

### ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®å¯¾è±¡

TypeScriptã¸ç§»è¡Œã¯ã§ããŸã®ã§ã™ãŒã€å…ƒã‚³ãƒ¼ãƒ‰ãŒJavaScriptã®prototypeã‚’ãƒ™ã‚¿æ›¸ãã—ã¦ã„ã‚‹ãŸã‚ã€ã¾ã¨ã‚‚ã«å‹ãŒåŠ¹ã„ã¦ãªã„çŠ¶æ…‹ã§ã—ãŸã€‚
ãŸã¨ãˆã°ã€æ¬¡ã®[models/book.ts](https://github.com/honkit/honkit/blob/93af869cf6417658e9921c290c6940832bea0ac1/packages/honkit/src/models/book.ts)ã¯[Immutable.js](https://immutable-js.github.io/immutable-js/)ã‚’ä½¿ã£ãŸãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦ã€prototypeãªã©ã§ç›´æ¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã—ãŸã€‚

ã“ã®å ´åˆã€`Book#getFS()` ãªã©ã‚’å‘¼ã³å‡ºãã†ã¨ã—ã¦ã€TypeScriptã®å‹ã«ã¯å…¥ã£ã¦ãªã„ã®ã§ã€`// @ts-expect-error` ã§ignoreã—ã¦å‘¼ã³å‡ºã™ã¨ã„ã£ãŸçŠ¶æ…‹ã§ã—ãŸã€‚

```js
import Immutable from "immutable";
import Logger from "../utils/logger";
const Book = Immutable.Record({
    logger: Logger(),
    // ...
});
// Instance Method
Book.prototype.getLogger = function () {
    return this.get("logger");
};

Book.prototype.getFS = function () {
    return this.get("fs");
};
/// ...

Book.createFromParent = function createFromParent(parent, language) {
    // Static Method
};

export default Book;
```

ã“ã‚Œã‚’å‹ã‚’åŠ¹ãçŠ¶æ…‹ã«ã™ã‚‹ã«ã¯ã€[Immutable.js](https://immutable-js.github.io/immutable-js/)ã§å®šç¾©ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’`class`ã¨ã—ã¦ç¶™æ‰¿ã—ã¦ã€ãã®ã‚¯ãƒ©ã‚¹ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã™ã‚‹æ–¹æ³•ãŒå–ã‚Œãã†ã§ã—ãŸã€‚

ã¤ã¾ã‚Šæ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã—ã¦ã„ã‘ã°ã€TypeScripçš„ã«ã‚‚å‹ãŒåŠ¹ãçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

```ts
import Immutable from "immutable";
import Logger from "../utils/logger";
class Book extends Immutable.Record({
    logger: Logger(),
    // ...
}){
    // Instance Method
    getLogger = function () {
        return this.get("logger");
    };

    getFS = function () {
        return this.get("fs");
    };
    /// ...
    static createFromParent = function createFromParent(parent, language) {
    // Static Method
    };
}
export default Book;
```

[jscodeshift](https://github.com/facebook/jscodeshift)ãªã©ASTãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ãˆã°ã§ããã†ã§ã™ãŒã€
ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã®ãŒé¢å€’ãã†ã§ã™ã€‚
ã¾ãŸã‚®ãƒªã‚®ãƒªæ–‡å­—åˆ—ç½®æ›ã§ã‚‚ã§ããã†ãªé›°å›²æ°—ã‚‚ã‚ã‚Šã¾ã™ãŒã€æ–‡å­—åˆ—ãƒãƒƒãƒã ã¨èª¤æ¤œçŸ¥ã—ãŸã‚Šã—ã¦é¢å€’ãã†ã§ã—ãŸã€‚

ãã“ã§ã€[Semgrep](https://github.com/returntocorp/semgrep)ã‚’ä½¿ã£ã¦åŠ´åŠ›ã¯ã‚ã¾ã‚Šã«ä½¿ã‚ãšã«ã“ã®ç½®æ›ã‚’ãƒ«ãƒ¼ãƒ«ã¨ã—ã¦å®šç¾©ã—ã¦ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã„ãã“ã¨ã«ã—ã¾ã—ãŸã€‚
å®Ÿéš›ã«ã‚„ã‚‹ã“ã¨ã‚’æ›¸ã„ãŸIssueã¯æ¬¡ã®Issueã§ã™ã€‚

- [Migrate models to class-based for improving TypeScript compatibility. Â· Issue #169 Â· honkit/honkit](https://github.com/honkit/honkit/issues/169)

### Semgrepã®ç½®æ›ã§ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

ã“ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§ä½¿ã£ãŸ[semgrep.yml](https://github.com/honkit/honkit/blob/220031ccff3a90ee47980a17ca332de0623531a6/packages/honkit/semgrep.yml)ã¯æ¬¡ã®ã‚ˆã†ãªå†…å®¹ã§ã™ã€‚

å°‘ã—é•·ã„ã§ã™ãŒã€4ã¤ã®ç½®æ›ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

- `const $X = Immutable.Record(...);` â†’ `class $X extends Immutable.Record(...){
    - Immutable.jsã®ãƒ¢ãƒ‡ãƒ«ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹
- `$X.prototype.$Y = function(...){ ... }` â†’ `$Y(...){ ... }`
    - prototypeã¸ã®ä»£å…¥ã‚’ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã«å¤‰æ›
- `$X.$Y = function(...){ ... }` â†’ `static $Y(...){ ... }`
    - Staticãƒ¡ã‚½ãƒƒãƒ‰ã«å¤‰æ›
- `export default $X;"` â†’ `}\nexport default $X;"`
    - `class {}` ã®ã‚«ãƒƒã‚³ã®å¯¾ã‚’è£œå®Œ

```yaml
# Migrate Immutable.js model to class-based
# https://github.com/honkit/honkit/issues/40#issuecomment-735353069
rules:
  - id: model
    languages:
      - typescript
    message: |
      use class
    pattern: "const $X = Immutable.Record(...);"
    fix-regex:
      regex: 'const (\w+) = ([\s\S]+);'
      replacement: 'class \1 extends \2{'
    severity: WARNING
  - id: instance-method
    languages:
      - typescript
    message: |
      prototype method to class instance methods
    patterns:
      - pattern: "$X.prototype.$Y = function(...){ ... }"
      - pattern: "$X.prototype.$Y = function $Y(...){ ... }"
      - pattern-not-inside: function (...){ ... }
    fix-regex:
      regex: '^(.*)\.prototype\.(.*) = function.*\('
      replacement: '\2('
    severity: WARNING
  - id: static-method
    languages:
      - typescript
    message: |
      static method to class statics methods
    patterns:
      - pattern: "$X.$Y = function(...){ ... }"
      - pattern: "$X.$Y = function $Y(...){ ... }"
      - pattern-not-inside: function (...){ ... }
    fix-regex:
      regex: '^(.*?)\.(.*?) = function.*\('
      replacement: 'static \2('
    severity: WARNING
  - id: export
    languages:
      - typescript
    message: |
      fix export
    pattern: "export default $X;"
    fix-regex:
      regex: 'export default'
      replacement: '}\nexport default'
    severity: WARNING
```

ã“ã®ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦ `semgrep --autofix` ã‚’ã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ç½®æ›ã§ãã¾ã™ã€‚
(å®Ÿéš›ã«ã¯ã‚¹ãƒšãƒ¼ã‚¹ãªã©ã¯ã‚ºãƒ¬ã¾ã™ãŒã€ä»Šã©ãã¯Prettierãªã©ã®FormatterãŒã‚ã‚‹ã®ã§æ°—ã«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“)

```diff
@@ -1,21 +1,20 @@
 import Immutable from "immutable";
 import Logger from "../utils/logger";
-const Book = Immutable.Record({
+class Book extends Immutable.Record({
     logger: Logger(),
     // ...
-});
-// Instance Method
-Book.prototype.getLogger = function () {
-    return this.get("logger");
-};
+}){
+    // Instance Method
+    getLogger = function () {
+        return this.get("logger");
+    };

-Book.prototype.getFS = function () {
-    return this.get("fs");
-};
-/// ...
-
-Book.createFromParent = function createFromParent(parent, language) {
+    getFS = function () {
+        return this.get("fs");
+    };
+    /// ...
+    static createFromParent = function createFromParent(parent, language) {
     // Static Method
-};
-
+    };
+}
```

### ãƒ«ãƒ¼ãƒ«ã®è§£èª¬

Semgrepã®ãƒ«ãƒ¼ãƒ«ã¯ç‰¹æ®Šãªæ§‹æ–‡ãŒå°‘ãªã„ã®ã§ã€è¦‹ãŸç›®ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
ã“ã®ãƒ«ãƒ¼ãƒ«ã§ã¯ã©ã®ã‚ˆã†ãªã“ã¨ã‚’ã‚„ã£ã¦ã„ã‚‹ã‹ã®è§£èª¬ã§ã™ã€‚

```yaml
# Migrate Immutable.js model to class-based
# https://github.com/honkit/honkit/issues/40#issuecomment-735353069
rules:
  - id: model
    languages:
      - typescript
    message: |
      use class
    pattern: "const $X = Immutable.Record(...);"
    fix-regex:
      regex: 'const (\w+) = ([\s\S]+);'
      replacement: 'class \1 extends \2{'
    severity: WARNING
  - id: instance-method
    languages:
      - typescript
    message: |
      prototype method to class instance methods
    patterns:
      - pattern: "$X.prototype.$Y = function(...){ ... }"
      - pattern: "$X.prototype.$Y = function $Y(...){ ... }"
      - pattern-not-inside: function (...){ ... }
    fix-regex:
      regex: '^(.*)\.prototype\.(.*) = function.*\('
      replacement: '\2('
    severity: WARNING
  - id: static-method
    languages:
      - typescript
    message: |
      static method to class statics methods
    patterns:
      - pattern: "$X.$Y = function(...){ ... }"
      - pattern: "$X.$Y = function $Y(...){ ... }"
      - pattern-not-inside: function (...){ ... }
    fix-regex:
      regex: '^(.*?)\.(.*?) = function.*\('
      replacement: 'static \2('
    severity: WARNING
  - id: export
    languages:
      - typescript
    message: |
      fix export
    pattern: "export default $X;"
    fix-regex:
      regex: 'export default'
      replacement: '}\nexport default'
    severity: WARNING
```

#### CSTã§ã®ãƒãƒƒãƒã¨æ­£è¦è¡¨ç¾ã§ã®ç½®æ›

æœ€åˆ(`id: model`)ã¨æœ€å¾Œ(`id: export`)ã®ãƒ«ãƒ¼ãƒ«ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“ã‚’`class { ... }` ã§åŒ…ã‚€ã‚ˆã†ã«ç½®æ›ã—ã¦ã„ã¾ã™ã€‚
[Semgrep](https://github.com/returntocorp/semgrep)ã®é¢ç™½ã„ã¨ã“ã‚ã¯ã€ç½®æ›ã«æ­£è¦è¡¨ç¾ãŒä½¿ãˆã‚‹ã¨ã“ã‚ã§ã™ã€‚
ã¾ãŸã€ã“ã®æ­£è¦è¡¨ç¾ã§ã®ç½®æ›çµæœã¯ã€æ§‹æ–‡çš„ã«æ­£ã—ããªã„ã‚³ãƒ¼ãƒ‰ã¸ã¨å¤‰æ›ã§ãã‚‹ç‚¹ãŒçµæ§‹è‡ªç”±åº¦ã‚’ã‚ã’ã¦ã„ã¾ã™ã€‚

æœ€åˆã®ãƒ«ãƒ¼ãƒ«(`id: model`)ã§ã‚ã‚‹`const $X = Immutable.Record(...);` â†’ `class $X extends Immutable.Record(...){`ã¨ã„ã†ç½®æ›ã§ã™ã€‚
ã“ã®ãƒ«ãƒ¼ãƒ«ã®å¤‰æ›çµæœã‚’å˜ç‹¬ã§è¦‹ã‚‹ã¨ `class {` ã«å¯¾ã™ã‚‹ `}` ãŒå­˜åœ¨ã—ãªã„ã®ã§æ§‹æ–‡çš„ã«ãŠã‹ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚
ã—ã‹ã—ã€ãƒãƒƒãƒã¾ã§ã¯CSTã‚’ä½¿ã£ãŸæ§‹æ–‡æœ¨ã§è¡Œã„ã€ç½®æ›ã¯`fix-regex`ã§ã®æ­£è¦è¡¨ç¾ã‚’ã—ã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚Semgrepã¯æ¬¡ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ç½®æ›å‡¦ç†ãŒã§ãã¾ã™ã€‚

1. CSTã§ã®ãƒãƒƒãƒ `pattern`
2. 1ã®ä¸­ã§ã•ã‚‰ã«ç½®æ›ç¯„å›²ã‚’æ­£è¦è¡¨ç¾ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€€`fix-regex.regex`
3. 2ã®ãƒãƒƒãƒã‹ã‚‰å®Ÿéš›ã«ç½®æ› `fix-regex.replacement`

ã“ã®ã‚ˆã†ãªæ„Ÿã˜ã§å¤§é›‘æŠŠã«æ§‹æ–‡æœ¨ã‚’ä½¿ã£ãŸãƒãƒƒãƒã‚’ã—ã¦ã€æ­£è¦è¡¨ç¾ã§ç´°ã‹ã„ã¨ã“ã‚ã‚’å–ã‚Šå‡ºã—ã¦ç½®æ›ã™ã‚‹å½¢ãŒã§ãã¾ã™ã€‚
ã™ã¹ã¦ã‚’ASTã§ãƒãƒƒãƒã¨ç½®æ›ã™ã‚‹å ´åˆã¯è¦šãˆã‚‹æ§‹æ–‡å¢—ãˆã‚‹ã®ã§é›£ã—ããªã‚ŠãŒã¡ã§ã™ãŒã€Semgrepã¯ç´°ã‹ã„ã¨ã“ã‚ã¯æ­£è¦è¡¨ç¾ã§ã§ãã‚‹ã®ã§ã‚³ã‚¹ãƒ‘ãŒè‰¯ã„æ„Ÿã˜ã§ã™ã€‚

ä¼¼ãŸã‚ˆã†ãªä»•çµ„ã¿ã¯ã€ä»¥å‰[nlp-pattern-match](https://github.com/azu/nlp-pattern-match)ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§æ›¸ã„ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
[nlp-pattern-match](https://github.com/azu/nlp-pattern-match)ã¯è‹±èªã‚„æ—¥æœ¬ã‚’å“è©åˆ†è§£ã—ã¦ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
æœ€åˆã«å“è©ã‚’ä½¿ã£ãŸãƒãƒƒãƒ(ASTã«ã‚ãŸã‚‹)ã‚’ã—ã¦ã€ãã®ãƒãƒƒãƒã—ãŸå†…å®¹ãŒæ­£è¦è¡¨ç¾ã§å†ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰ã€æ­£è¦è¡¨ç¾ã§ç½®æ›ã™ã‚‹ã¨ã„ã†ä»•çµ„ã¿ã§ã™ã€‚

[jscodeshift](https://github.com/facebook/jscodeshift)ã¨ã„ã£ãŸASTã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ã“ã®æ“ä½œã‚’åŸºæœ¬çš„ã«ASTã®æ›¸ãæ›ãˆã§è¡Œã„ã¾ã™ã€‚
ASTã§æ›¸ãæ›ãˆã¾ã§è¡Œã†ã¨ã€ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã¯æ§‹æ–‡ã¨ã—ã¦å£Šã‚Œã¦ãªã„ã“ã¨ãŒä¿è¨¼ã§ãã¾ã™ãŒã€å¤‰æ›ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ã‹ãªã‚Šå†—é•·ã«ãªã‚Šã¾ã™ã€‚

[jscodeshift](https://github.com/facebook/jscodeshift)ãªã©ã‚’ä½¿ã£ãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ¬¡ã®è¨˜äº‹ã‚„ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

- [JavaScript ASTã‚’ä½¿ã£ãŸãƒ„ãƒ¼ãƒ«(è‡ªä½œã€ESLintã€Babelã€jscodeshift)ã‚’å®Ÿè£…ã™ã‚‹è©± | Web Scratch](https://efcl.info/2019/12/03/dive-to-ast/)
- [Dive into AST](https://dive-into-ast.netlify.app/)

#### patternã®çµ„ã¿åˆã‚ã›

æ¬¡ã®ãƒ«ãƒ¼ãƒ«ã¯ãã‚Œãã‚Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¨é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã¸ã®ç½®æ›ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

```yaml
  - id: instance-method
    languages:
      - typescript
    message: |
      prototype method to class instance methods
    patterns:
      - pattern: "$X.prototype.$Y = function(...){ ... }"
      - pattern: "$X.prototype.$Y = function $Y(...){ ... }"
      - pattern-not-inside: function (...){ ... }
    fix-regex:
      regex: '^(.*)\.prototype\.(.*) = function.*\('
      replacement: '\2('
    severity: WARNING
  - id: static-method
    languages:
      - typescript
    message: |
      static method to class statics methods
    patterns:
      - pattern: "$X.$Y = function(...){ ... }"
      - pattern: "$X.$Y = function $Y(...){ ... }"
      - pattern-not-inside: function (...){ ... }
    fix-regex:
      regex: '^(.*?)\.(.*?) = function.*\('
      replacement: 'static \2('
    severity: WARNING
```

åŸºæœ¬çš„ã«ã¯æ–‡å­—åˆ—ç½®æ›ã¨ã‚ã¾ã‚Šå¤‰ã‚ã‚Šã¾ã›ã‚“ãŒã€`pattern-not-inside`ã‚’ä½¿ã£ã¦èª¤æ¤œçŸ¥ã‚’æ¸›ã‚‰ã—ã¦ã„ã¾ã™ã€‚
[pattern-not-inside](https://semgrep.dev/docs/writing-rules/rule-syntax/#pattern-not-inside)ã¯ç‰¹å®šã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å†…å´ã§ã¯ãªã„ã“ã¨ã‚’ANDæ¡ä»¶ã«è¶³ã›ã¾ã™ã€‚

ä¾‹ãˆã°æ¬¡ã®é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯é–¢æ•°ã®å†…å´ã§ã¯ãªã„ã¨ã„ã†æ¡ä»¶ã‚’`pattern-not-inside`ã§è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

```yaml
    patterns:
      - pattern: "$X.$Y = function(...){ ... }"
      - pattern: "$X.$Y = function $Y(...){ ... }"
      - pattern-not-inside: function (...){ ... }
```

ã“ã®`pattern-not-inside`ã«ã‚ˆã£ã¦ã€æ¬¡ã®ã‚ˆã†ãªå ´åˆã¯é™¤å¤–ã•ã‚Œã¾ã™ã€‚
ãã®ã¾ã¾ã€`$X.$Y = function(...){ ... }` ã«ãƒãƒƒãƒã™ã‚‹ã‹ã‚‰ã¨ã„ã£ã¦ç½®æ›ã™ã‚‹ã¨ãŠã‹ã—ãªã“ã¨ã«ãªã‚‹ã®ã‚’é¿ã‘ã‚‹ä¾‹å¤–ãƒ«ãƒ¼ãƒ«çš„ãªã‚‚ã®ã§ã™ã€‚

```js
Book.prototype.init = function(...){
    this.onLoad = function(...){ ... }
}
```

ASTã§ã‚„ã‚‹å ´åˆã¯ã€ãƒãƒƒãƒã—ãŸè¦ç´ ã®parentãŒé–¢æ•°ã§ã¯ãªã„ã¿ãŸã„ãªãƒã‚§ãƒƒã‚¯ã‚’æ›¸ã„ãŸã‚Šã™ã‚‹ã®ã§ã™ãŒã€
`pattern-not-inside`ã‚„`pattern-inside`ã§åŒæ§˜ã®ã“ã¨ãŒãƒ•ãƒ©ãƒƒãƒˆãªæ„Ÿã˜ã§ãƒ«ãƒ¼ãƒ«ã¨ã—ã¦è¡¨ç¾ã§ãã‚‹ã®ãŒçµæ§‹ä¾¿åˆ©ã§ã—ãŸã€‚

## ã¾ã¨ã‚

[Semgrep](https://github.com/returntocorp/semgrep)ã¯ã€æ­£è¦è¡¨ç¾ã§ã¯é›£ã—ãASTãƒ„ãƒ¼ãƒ«ã§ã¯é¢å€’ãªãƒã‚§ãƒƒã‚¯ã‚„å¤‰æ›ãŒã‚ã‚‹ç¨‹åº¦ç°¡å˜ã«æ›¸ã‘ã‚‹ã®ãŒç‰¹å¾´ã§ã™ã€‚

ä»Šã¯ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€JavaScriptã§ã¯[grasp](http://www.graspjs.com/)ã¨ã„ã†ä¼¼ãŸASTãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ã‚„ç½®æ›ã‚’è¡Œã†ãƒ„ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã—ãŸã€‚

- [Graspã‚’ä½¿ã£ãŸJavaScriptã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° - JSer.info](https://jser.info/post/73202282881/grasp-javascript)

Graspã§ã¯[equery](http://www.graspjs.com/docs/equery/)ã‚„[squery](http://www.graspjs.com/docs/squery/)ã®ã‚ˆã†ã«ã‚¯ã‚¨ãƒªè¨€èªã‚’å°‘ã—è¦šãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
[Semgrep](https://semgrep.dev/)ã§ã¯ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã¨AND/OR/NOTã®çµ„åˆã‚ã›ã§ãƒãƒƒãƒãƒ³ã‚°ç¯„å›²ã‚’çµã‚Šè¾¼ã‚“ã§ã€
ãã®ãƒãƒƒãƒã—ãŸä¸­ã‹ã‚‰æ­£è¦è¡¨ç¾ã§ç´°ã‹ã„å‡¦ç†ã‚’ã™ã‚‹ã¨ã„ã£ãŸæ®µéšçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ã¨ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€å­¦ç¿’ã‚³ã‚¹ãƒˆã¯å°‘ãªãã¦æ–‡å­—åˆ—ç½®æ›ã«è¿‘ã„ã‘ã©ã€ã‚ˆã‚Šæ­£ç¢ºãªç½®æ›ãŒã§ãã‚‹ã®ãŒä¾¿åˆ©ãªã¨ã“ã‚ã§ã™ã€‚

Semgrepã®[Comparisons](https://semgrep.dev/docs/faq/#comparisons)ã‚’è¦‹ã¦ã‚‚ã€Linterãªã©ã«æ¯”ã¹ã¦ç°¡å˜ã«ãƒ«ãƒ¼ãƒ«ã‚’ä½œã‚Œã‚‹ã¨ã“ã‚æ¨ã—ã¦ã„ã‚‹æ„Ÿã˜ãŒã—ã¾ã™ã€‚

ESLintãªã©ã®Linterã¯ASTãƒ™ãƒ¼ã‚¹ã§ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ãã¾ã™ãŒã€ã¡ã‚‡ã£ã¨ã—ãŸãƒã‚§ãƒƒã‚¯ã‚‚ASTãƒ™ãƒ¼ã‚¹ã§æ›¸ãå¿…è¦ãŒã‚ã‚‹ã®ã§ã€ãƒ«ãƒ¼ãƒ«ã‚’è¶³ã™ã®ãŒæ°—è»½ã¨ã„ã†æ„Ÿã˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãŸã¨ãˆã°ã€Node.jsã§[child_process.exec](https://nodejs.org/api/child_process.html#child_process_child_process_exec_command_options_callback)ã«å¤‰æ•°ã‚’æ¸¡ã—ã¦ã‚‹ã‚±ãƒ¼ã‚¹ã‚’è¦‹ã¤ã‘ãŸã„ã¨ã—ã¾ã™ã€‚
ã“ã®å¤‰æ•°ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã ã£ãŸã‚‰[Command Injection](https://owasp.org/www-community/attacks/Command_Injection)ã®è„†å¼±æ€§ã«ãªã‚Šã¾ã™ã€‚

```js
chilre_proecss.exec(input);
chilre.exec(input);
exec(input);
```

ã“ã‚Œã‚’ASTã§ã¾ã¨ã‚‚ã«ã‚„ã‚ã†ã¨ã™ã‚‹ã¨å°‘ã—é¢å€’ã§ã™ãŒã€Semgrepã ã¨`patterns:`ã‚’ä¹±é›‘ã«ä¸¦ã¹ã¦ã„ãã ã‘ã§ã¨ã‚Šã‚ãˆãšæ¤œçŸ¥ã§ãã¾ã™ã€‚
ã“ã®ã‚ˆã†ã«ã–ã£ãã‚Šã¨ã—ãŸãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã‚„ã™ã„ã®ãŒç‰¹å¾´çš„ã§ã™ã€‚ä¸€æ–¹ã§ã‚‚ã£ã¨ã„ã‚ã„ã‚ãªã‚±ãƒ¼ã‚¹ã‚’æƒ³å®šã—ãŸå ´åˆã¯ã€ESLintã®ã‚ˆã†ãªãƒ«ãƒ¼ãƒ«ã®ã»ã†ãŒèª¤æ¤œçŸ¥ã¯ã—ã«ãã„ã¨æ€ã„ã¾ã™ã€‚

```
rules:
  - id: command-inection-check
    languages:
      - javascript
    message: |
      Disallow to use exec(val)
    patterns:
      - pattern: exec(...)
      - pattern-not: exec("...")
      - pattern: child.exec(...)
      - pattern-not: child.exec("...")
      - pattern: child_process.exec(...)
      - pattern-not: child_process.exec("...")
    severity: WARNING
```

[CodeQL](https://securitylab.github.com/tools/codeql)ã¨ã®æ¯”è¼ƒã‚‚ã‚ã‚Šã¾ã™ãŒã€CodeQLã¯ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è§£æã‚’ã™ã‚‹GitHubãŒè²·åã—ãŸãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è§£æã«ã‚ˆã£ã¦ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ã‚’æ±šæŸ“ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿(Taint)ã¨ã—ã¦ã€ãã®ãƒ‡ãƒ¼ã‚¿ãŒã©ã“ã‹ã‚‰æ¥ã¦ï¼ˆSourceï¼‰ã€ã©ã“ã«è¡Œãï¼ˆsinkï¼‰ã‹ã‚’è§£æã§ãã‚‹ã®ã§ã€Semgrepã«æ¯”ã¹ã‚‹ã¨æ·±ã„ã‚¹ã‚­ãƒ£ãƒ³ãŒã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’çµŒç”±ã—ã¦æ¸¡ã£ã¦ããŸURLã‚’Taintãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã£ã¦ã€ãã®URLã«å¯¾ã—ã¦ã‚µãƒ¼ãƒã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ãŸã‚‰[SSRF](https://portswigger.net/web-security/ssrf)ã®è„†å¼±æ€§ã ã‚ˆã­ã£ã¦æ„Ÿã˜ã§ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’è§£æã—ãŸã‚Š[è‘—åãªè„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¯ã‚¨ãƒª](https://github.com/github/codeql)ãªã©ãŒæƒã£ã¦ã„ãŸã‚Šã™ã‚‹ã®ã§ä¾¿åˆ©ã§ã™ãŒã€äº‹å‰ã«ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŒ–ã—ãŸã‚Šçµæ§‹ã‚¹ã‚­ãƒ£ãƒ³ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã¨ã„ã£ãŸé•ã„ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€Semgrepã¨ã®æ¯”è¼ƒå¯¾è±¡ã¨ã—ã¦ã¯é©å½“ã§ã¯ãªã„æ„Ÿã˜ãŒã—ã¾ã™ã€‚(ä¼¼ãŸã‚ˆã†ãªã“ã¨ã¯ã§ãã‚‹ã‘ã©)

[Semgrep](https://github.com/returntocorp/semgrep)ã¯ã¾ã é–‹ç™ºä¸­ã¨ã„ã†æ„Ÿã˜ã®ãƒ„ãƒ¼ãƒ«ã§ã™ãŒã€
æ–‡å­—åˆ—ç½®æ›ã ã¨ä¸å®‰ã ã‘ã©ã€ASTã‚’ä½¿ã†ãƒ„ãƒ¼ãƒ«æ›¸ãã®ã¯é¢å€’ãã•ã„ã¨ã„ã†éœ€è¦ã‚’æº€ãŸã—ã¦ãã‚Œã‚‹ã¡ã‚‡ã†ã©ã„ã„æ„Ÿã˜ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
è¦šãˆã¦ãŠãã¨ä¾¿åˆ©ãªã¨ããŒã‚ã‚‹æ„Ÿã˜ãŒã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã—ãŸã€‚
